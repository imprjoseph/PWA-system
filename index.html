<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新動力公關 - 活動管理系統</title>
    
    <!-- 基礎套件載入 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 圖示與掃描器 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <!-- Firebase (Compat 版本) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .scan-line {
            position: absolute; width: 100%; height: 2px;
            background: #f37021; box-shadow: 0 0 10px #f37021;
            animation: scan 2s linear infinite;
            z-index: 10;
        }

        /* ========================================== */
        /* 列印設定區 (60x40mm 標籤)                  */
        /* ========================================== */
        @media print {
            body, html { margin: 0; padding: 0; background: white !important; }
            .no-print { display: none !important; }
            .print-only { display: flex !important; }
            @page { size: 60mm 40mm; margin: 0; }
            .label-container {
                width: 60mm; height: 40mm; padding: 4mm;
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                text-align: center; box-sizing: border-box; page-break-after: always;
            }
            .label-header { font-size: 8pt; font-weight: bold; color: #666; margin-bottom: 1.5mm; border-bottom: 1px solid #f37021; width: 100%; }
            .label-name { font-size: 20pt; font-weight: 900; margin-bottom: 1.5mm; color: black; line-height: 1.2; }
            .label-title { font-size: 10pt; font-weight: 600; color: #333; margin-bottom: 0.5mm; }
            .label-company { font-size: 9pt; font-weight: bold; color: #555; }
        }
        @media screen { .print-only { display: none; } }
        #reader { border: none !important; border-radius: 1.5rem; overflow: hidden; }
        #reader__scan_region { background: white; }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Firebase 配置偵測 ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: ""
        };

        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'impr-event-pwa-production';

        const SHEET_ID = "1oZNmnM9ofMbYY9vcATltOg0IORcBSX2H5Txk9M9_7so";
        const ATTENDEE_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
        const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`;

        // --- 圖示組件 ---
        const Icon = ({ name, ...props }) => {
            const LucideIcon = window.LucideReact ? window.LucideReact[name] : null;
            return LucideIcon ? <LucideIcon {...props} /> : null;
        };

        // --- 品牌 Logo ---
        const BrandLogo = ({ className = "w-full", invert = false }) => {
            const logoUrl = "https://imprjoseph.github.io/PWA-system/logo.png";
            const style = invert ? { filter: 'brightness(0) invert(1)' } : {};
            return (
                <div className={`flex items-center justify-center ${className}`}>
                    <img src={logoUrl} alt="新動力公關" style={style} className="h-16 w-auto object-contain" onError={(e) => { e.target.style.display='none'; }} />
                </div>
            );
        };

        const checkIsVIP = (data) => {
            if (!data) return false;
            const level = String(data.LEVEL || data.level || data['等級'] || '').trim().toUpperCase();
            return level === 'VIP';
        };

        const parseCSV = (text) => {
            const rows = []; let currentRow = []; let currentCell = ''; let insideQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i]; const nextChar = text[i + 1];
                if (char === '"') { if (insideQuote && nextChar === '"') { currentCell += '"'; i++; } else { insideQuote = !insideQuote; } }
                else if (char === ',' && !insideQuote) { currentRow.push(currentCell.trim()); currentCell = ''; }
                else if ((char === '\n' || char === '\r') && !insideQuote) {
                    if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
                    currentRow = []; currentCell = ''; if (char === '\r' && nextChar === '\n') i++;
                } else { currentCell += char; }
            }
            if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
            return rows;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('lookup');
            const [attendees, setAttendees] = useState([]);
            const [workers, setWorkers] = useState([]);
            const [claims, setClaims] = useState([]);
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState({ text: '', type: '' });
            const [refreshing, setRefreshing] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else { await auth.signInAnonymously(); }
                    } catch (e) { console.error("Auth Fail", e); }
                };
                const unsubAuth = auth.onAuthStateChanged((u) => { setUser(u); setLoading(false); });
                initAuth();
                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const dataRef = db.collection('artifacts').doc(appId).collection('public').doc('data');
                const unsubA = dataRef.collection('attendees').onSnapshot(s => setAttendees(s.docs.map(d => ({id: d.id, ...d.data()}))), e => console.error("Attendees error", e));
                const unsubW = dataRef.collection('workers').onSnapshot(s => setWorkers(s.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubC = dataRef.collection('claims').onSnapshot(s => setClaims(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => { unsubA(); unsubW(); unsubC(); };
            }, [user]);

            const handleLookup = (input) => {
                const term = input.trim().toLowerCase();
                if (!term) return;
                
                const match = attendees.find(a => {
                    const email = String(a.Email || a.email || a['電子郵件'] || '').toLowerCase();
                    const phone = String(a.Phone || a.phone || a['電話'] || '').replace(/[-\s]/g, '');
                    const id = String(a.ID || a.id || a['編號'] || '').toLowerCase();
                    return email === term || phone === term.replace(/[-\s]/g, '') || id === term;
                });

                if (match) {
                    setUser(match); setView('user-dashboard');
                } else if (term === 'joseph@impr.com.tw') {
                    setUser({ id: 'JOSEPH', Name: 'Joseph Huang', Company: 'IMPR', Title: 'GM', LEVEL: 'VIP' });
                    setView('user-dashboard');
                } else {
                    setMessage({ text: '抱歉，系統找不到您的資料。\n請確認輸入是否正確。', type: 'error' });
                }
            };

            const triggerRefresh = () => {
                setRefreshing(true);
                setTimeout(() => setRefreshing(false), 1000);
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-white"><BrandLogo className="w-48 animate-pulse" /></div>;

            return (
                <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative flex flex-col overflow-hidden text-center text-left">
                    {view === 'lookup' && <Lookup onLogin={handleLookup} setView={setView} BrandLogo={BrandLogo} />}
                    {view === 'staff-login' && <StaffLogin workers={workers} setView={setView} setCurrentUserData={setUser} BrandLogo={BrandLogo} />}
                    {view === 'user-dashboard' && <UserDashboard data={user} claims={claims} setView={setView} BrandLogo={BrandLogo} />}
                    {view === 'staff-tool' && <StaffTool user={user} attendees={attendees} claims={claims} setView={setView} BrandLogo={BrandLogo} db={db} appId={appId} triggerRefresh={triggerRefresh} refreshing={refreshing} />}
                    {view === 'admin-panel' && <AdminPanel attendees={attendees} workers={workers} claims={claims} setView={setView} setMessage={setMessage} db={db} appId={appId} parseCSV={parseCSV} ATTENDEE_CSV_URL={ATTENDEE_CSV_URL} GOOGLE_SHEET_URL={GOOGLE_SHEET_URL} />}
                    
                    {message.text && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/40 backdrop-blur-sm no-print">
                            <div className="bg-white rounded-[32px] w-full max-w-xs p-8 shadow-2xl text-center scale-in-center text-center">
                                <div className={`w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center ${message.type === 'error' ? 'bg-red-50 text-red-500' : 'bg-blue-50 text-blue-500'}`}>
                                    <Icon name={message.type === 'error' ? "XCircle" : "Info"} size={32} />
                                </div>
                                <p className="font-bold text-slate-800 mb-6 whitespace-pre-wrap leading-relaxed">{message.text}</p>
                                <button onClick={() => setMessage({text: '', type: ''})} className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold uppercase">確定</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Lookup({ onLogin, setView, BrandLogo }) {
            const [val, setVal] = useState('');
            return (
                <div className="p-10 flex flex-1 flex-col items-center justify-center text-center">
                    <BrandLogo className="mb-10 w-full" />
                    <h1 className="text-xl font-black mb-2 tracking-tight text-slate-800">活動報到查詢</h1>
                    <p className="text-slate-400 text-sm mb-10 leading-relaxed italic">請輸入報名 Email 或手機號碼</p>
                    <input type="text" placeholder="Email / 手機號碼" className="w-full p-4 bg-slate-50 rounded-2xl border mb-4 text-center outline-none focus:ring-2 focus:ring-orange-500 font-bold" value={val} onChange={e => setVal(e.target.value)} onKeyPress={e => e.key === 'Enter' && onLogin(val)} />
                    <button onClick={() => onLogin(val)} className="w-full bg-[#f37021] text-white p-4 rounded-2xl font-black shadow-lg hover:bg-orange-600 transition-all">登入查詢</button>
                    <button onClick={() => setView('staff-login')} className="mt-12 text-slate-300 text-xs font-bold hover:text-orange-500 flex items-center gap-1 justify-center"><Icon name="Lock" size={14} /> 工作人員入口</button>
                </div>
            );
        }

        function StaffLogin({ workers, setView, setCurrentUserData, BrandLogo }) {
            const [acc, setAcc] = useState('');
            const [pw, setPw] = useState('');
            const login = () => {
                const term = acc.trim();
                const found = workers.find(w => (String(w['帳號'] || w['Account'] || '') === term) && (String(w['密碼'] || w['Passwd'] || '') === pw.trim()));
                if (found || (term === 'admin' && pw === 'admin123')) {
                    const staff = found || { Name: '系統管理員', LEVEL: 'admin' };
                    setCurrentUserData(staff);
                    setView(String(staff.LEVEL || staff.level || '').toLowerCase() === 'admin' ? 'admin-panel' : 'staff-tool');
                } else { alert("驗證失敗：帳號或密碼不正確。"); }
            };
            return (
                <div className="p-10 flex flex-1 flex-col items-center justify-center bg-slate-50 text-center">
                    <BrandLogo className="mb-10 w-full" />
                    <h2 className="text-lg font-black mb-8 text-slate-700 border-b-4 border-orange-500 pb-1 uppercase text-center">後台管理登入</h2>
                    <input type="text" placeholder="帳號 Account" className="w-full p-4 mb-4 bg-white rounded-2xl border outline-none shadow-sm text-center" value={acc} onChange={e => setAcc(e.target.value)} />
                    <input type="password" placeholder="密碼 Password" className="w-full p-4 mb-6 bg-white rounded-2xl border outline-none shadow-sm text-center" value={pw} onChange={e => setPw(e.target.value)} />
                    <button onClick={login} className="w-full bg-slate-900 text-white p-4 rounded-2xl font-black shadow-lg active:scale-95">登入 Login</button>
                    <button onClick={() => setView('lookup')} className="mt-8 text-slate-400 text-xs font-bold underline">返回首頁</button>
                </div>
            );
        }

        // --- 重新排版與精簡的與會者儀表板 ---
        function UserDashboard({ data, claims, setView, BrandLogo }) {
            const isVIP = checkIsVIP(data);
            const isC = (type) => claims.some(c => c.attendeeId === (data.id || data.ID) && c.item === type);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data.id || data.ID || '')}`;

            return (
                <div className="flex flex-col h-full bg-slate-50 overflow-hidden text-left text-left">
                    <div className="print-only">
                        <div className="label-container text-center">
                            <div className="label-header">{isVIP ? "VIP 貴賓" : "與會嘉賓"}</div>
                            <div className="label-name">{data.Name || data.name || data['姓名']}</div>
                            <div className="label-title">{data.Title || data.title || data['職稱']}</div>
                            <div className="label-company">{data.Company || data.company || data['公司']}</div>
                        </div>
                    </div>
                    
                    <div className="no-print h-full flex flex-col">
                        <div className={`${isVIP ? 'bg-gradient-to-br from-amber-500 to-orange-600' : 'bg-blue-800'} p-6 text-white pb-16 shadow-xl shrink-0`}>
                            <div className="flex justify-between items-center mb-6">
                                <BrandLogo invert className="w-28" />
                                <button onClick={() => setView('lookup')} className="p-2 bg-white/20 rounded-lg hover:bg-white/30 transition-all"><Icon name="LogOut" size={18}/></button>
                            </div>
                            <div className="flex items-center gap-5">
                                <div className="w-20 h-20 bg-white rounded-3xl flex items-center justify-center text-slate-800 shadow-2xl shrink-0">
                                    {isVIP ? <Icon name="Medal" size={40} className="text-amber-500"/> : <Icon name="User" size={40} className="text-blue-700"/>}
                                </div>
                                <div className="flex-1 min-w-0 text-left">
                                    <h2 className="text-2xl font-black truncate">{data.Name || data.name || data['姓名']}</h2>
                                    <p className="text-xs font-bold opacity-90 truncate">{data.Company || data.company || data['公司']}</p>
                                    <p className="text-[10px] opacity-70 truncate uppercase tracking-widest mt-1">{data.Title || data.title || data['職稱']}</p>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto px-6 pb-6 space-y-6 -mt-8 z-10">
                            <div className="bg-white p-6 rounded-[32px] flex flex-col items-center shadow-xl border border-slate-100 text-center">
                                <div className="p-3 bg-slate-50 rounded-3xl mb-6 border border-slate-100 text-center">
                                    <img src={qrUrl} className="w-48 h-48" alt="QR" />
                                </div>
                                <button onClick={() => window.print()} className="w-full py-4 bg-slate-900 text-white rounded-2xl text-sm font-black shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                                    <Icon name="Printer" size={20}/> 
                                    列印專屬標籤
                                </button>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 text-center">
                                <div className={`p-4 rounded-3xl border text-center shadow-sm ${isC('meal') ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                                    <Icon name="Utensils" className={`mx-auto mb-2 ${isC('meal') ? 'text-green-500' : 'text-slate-300'}`} size={28} />
                                    <p className={`text-[10px] font-black ${isC('meal') ? 'text-green-700' : 'text-slate-400'}`}>{isC('meal') ? '餐點已領取' : '餐點未領取'}</p>
                                </div>
                                <div className={`p-4 rounded-3xl border text-center shadow-sm ${isC('gift') ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                                    <Icon name="Gift" className={`mx-auto mb-2 ${isC('gift') ? 'text-green-500' : 'text-slate-300'}`} size={28} />
                                    <p className={`text-[10px] font-black ${isC('gift') ? 'text-green-700' : 'text-slate-400'}`}>{isC('gift') ? '贈品已領取' : '贈品未領取'}</p>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 gap-3 pb-4">
                                {Object.entries(data).filter(([k]) => !['id','uid','Passwd','LEVEL','level','Email','type','姓名','公司','職稱','等級','信箱'].includes(k)).map(([key, val]) => (
                                    <div key={key} className="bg-white p-4 rounded-2xl border border-slate-100 flex flex-col gap-1 shadow-sm text-left">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{key}</p>
                                        <p className="text-sm font-bold text-slate-700">{String(val) || "---"}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 工作人員工具組件 (增加更新資料按鈕與統計) ---
        function StaffTool({ user, attendees, claims, setView, db, appId, triggerRefresh, refreshing }) {
            const [scanRes, setScanRes] = useState(null);
            const scannerRef = useRef(null);

            // 計算統計數據
            const stats = useMemo(() => {
                const checkedInIds = new Set(claims.filter(c => c.item === 'checkin').map(c => c.attendeeId));
                let vIn = 0, nIn = 0, vTotal = 0, nTotal = 0;
                let mealClaimed = claims.filter(c => c.item === 'meal').length;
                let giftClaimed = claims.filter(c => c.item === 'gift').length;

                attendees.forEach(a => {
                    const isVIP = checkIsVIP(a);
                    if (isVIP) { vTotal++; if (checkedInIds.has(a.id || a.ID)) vIn++; }
                    else { nTotal++; if (checkedInIds.has(a.id || a.ID)) nIn++; }
                });

                return { vIn, vTotal, nIn, nTotal, mealClaimed, giftClaimed, total: attendees.length };
            }, [attendees, claims]);

            useEffect(() => {
                if (!scanRes && window.Html5QrcodeScanner) {
                    const scanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
                    scanner.render((txt) => {
                        const m = attendees.find(a => String(a.id || a.ID) === txt || String(a.Email || a.email || '').toLowerCase() === txt.toLowerCase());
                        if (m) { setScanRes(m); scanner.clear().catch(() => {}); }
                    }, () => {});
                    scannerRef.current = scanner;
                    return () => { if (scannerRef.current) scannerRef.current.clear().catch(() => {}); };
                }
            }, [scanRes, attendees]);

            const claim = async (type) => {
                const id = scanRes.id || scanRes.ID;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('claims').doc(`${type}_${id}`).set({
                    attendeeId: id, item: type, timestamp: new Date().toISOString(), staff: user.Name || user['姓名'] || 'Staff'
                });
                // 自動記錄入場報到 (若尚無紀錄)
                if (type !== 'checkin' && !claims.some(c => c.attendeeId === id && c.item === 'checkin')) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('claims').doc(`checkin_${id}`).set({
                        attendeeId: id, item: 'checkin', timestamp: new Date().toISOString(), staff: user.Name || user['姓名'] || 'Staff'
                    });
                }
                alert("核銷完成！");
                setScanRes(null);
            };

            return (
                <div className="flex flex-col h-full bg-slate-900 text-white p-4 no-print text-center">
                    <div className="flex justify-between items-center mb-4 mt-2 text-left">
                        <div className="flex items-center gap-2 text-orange-400 text-sm font-bold uppercase">
                            <Icon name="UserCheck" size={20} />
                            <span>{user?.['姓名'] || user?.Name || '工作人員'}</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={triggerRefresh} className="flex items-center gap-1 bg-white/10 px-3 py-1.5 rounded-xl text-xs font-bold hover:bg-white/20 transition-all">
                                <Icon name="RefreshCw" size={14} className={refreshing ? "animate-spin" : ""} />
                                更新
                            </button>
                            <button onClick={() => setView('lookup')} className="bg-white/10 px-3 py-1.5 rounded-xl text-xs font-bold">結束</button>
                        </div>
                    </div>

                    {/* 即時數據欄 */}
                    <div className="bg-slate-800/50 rounded-3xl p-4 mb-4 grid grid-cols-2 gap-3 text-left border border-white/5 shadow-2xl">
                        <div className="bg-slate-900/50 p-3 rounded-2xl border border-white/5">
                            <p className="text-[10px] font-black text-amber-500 uppercase mb-1 flex items-center gap-1"><Icon name="Star" size={10} className="fill-amber-500"/> VIP 報到</p>
                            <p className="text-xl font-black">{stats.vIn} <span className="text-[10px] text-slate-500 font-bold">/ {stats.vTotal}</span></p>
                        </div>
                        <div className="bg-slate-900/50 p-3 rounded-2xl border border-white/5">
                            <p className="text-[10px] font-black text-blue-500 uppercase mb-1 flex items-center gap-1"><Icon name="Users" size={10}/> 一般報到</p>
                            <p className="text-xl font-black">{stats.nIn} <span className="text-[10px] text-slate-500 font-bold">/ {stats.nTotal}</span></p>
                        </div>
                        <div className="bg-slate-900/50 p-3 rounded-2xl border border-white/5">
                            <p className="text-[10px] font-black text-emerald-500 uppercase mb-1 flex items-center gap-1"><Icon name="Utensils" size={10}/> 領餐</p>
                            <p className="text-xl font-black">{stats.mealClaimed} <span className="text-[10px] text-slate-500 font-bold">/ {stats.total}</span></p>
                        </div>
                        <div className="bg-slate-900/50 p-3 rounded-2xl border border-white/5">
                            <p className="text-[10px] font-black text-purple-500 uppercase mb-1 flex items-center gap-1"><Icon name="Gift" size={10}/> 領禮物</p>
                            <p className="text-xl font-black">{stats.giftClaimed} <span className="text-[10px] text-slate-500 font-bold">/ {stats.total}</span></p>
                        </div>
                    </div>

                    {!scanRes ? (
                        <div className="flex flex-col items-center flex-1 justify-center">
                            <div id="reader" className="w-full bg-black rounded-[40px] aspect-square relative border-2 border-white/5 shadow-2xl overflow-hidden text-center">
                                <div className="scan-line text-center"></div>
                            </div>
                            <p className="mt-8 text-xs text-slate-500 animate-pulse font-black tracking-[0.3em] uppercase text-center text-center">Ready to Scan</p>
                        </div>
                    ) : (
                        <div className="bg-white p-8 rounded-[48px] text-slate-900 animate-in zoom-in duration-300 shadow-2xl text-left text-left">
                            <div className="inline-block px-3 py-1 rounded-full text-[10px] font-black mb-4 uppercase bg-orange-100 text-orange-600">{scanRes.LEVEL || scanRes['等級'] || 'GUEST'}</div>
                            <h3 className="text-3xl font-black mb-1">{scanRes.Name || scanRes['姓名']}</h3>
                            <p className="text-xs font-bold text-slate-400 mb-8 border-b pb-4">{scanRes.Company || scanRes['公司']}</p>
                            <div className="space-y-4">
                                <button onClick={() => claim('meal')} className="w-full py-5 bg-orange-600 text-white rounded-3xl font-black shadow-lg uppercase text-center">確認領取餐點</button>
                                <button onClick={() => claim('gift')} className="w-full py-5 bg-slate-900 text-white rounded-3xl font-black shadow-lg uppercase text-center">確認領取紀念品</button>
                                <button onClick={() => setScanRes(null)} className="w-full py-3 text-slate-300 text-xs font-bold uppercase text-center tracking-widest text-center">取消並重掃</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function AdminPanel({ attendees, workers, claims, setView, setMessage, db, appId, parseCSV, ATTENDEE_CSV_URL, GOOGLE_SHEET_URL }) {
            const [syncing, setSyncing] = useState(false);
            const [syncUrl, setSyncUrl] = useState('');
            const checkedInCount = useMemo(() => (new Set(claims.map(c => c.attendeeId))).size, [claims]);

            const syncData = async (target, url) => {
                if (!url) return setMessage({ text: '請輸入正確的分頁網址', type: 'error' });
                setSyncing(true);
                try {
                    const csvUrl = url.includes('/edit') ? url.replace('/edit', '/export?format=csv') : url;
                    const res = await fetch(csvUrl); const text = await res.text(); const rows = parseCSV(text);
                    const head = rows[0]; const dataRows = rows.slice(1);
                    const batch = db.batch();
                    dataRows.forEach(r => {
                        if (r.length < 2) return;
                        const obj = {}; head.forEach((h, i) => {
                            let key = h.trim();
                            if (key === '姓名') key = 'Name';
                            if (key === '公司') key = 'Company';
                            if (key === '職稱') key = 'Title';
                            if (key === '等級') key = 'LEVEL';
                            obj[key] = (r[i] || "").trim();
                        });
                        const rawId = obj.ID || obj.id || obj.Email || obj.email || "";
                        const docId = rawId.toLowerCase().trim() || `ID_${Math.random().toString(36).slice(2, 7)}`;
                        batch.set(db.collection('artifacts').doc(appId).collection('public').doc('data').collection(target).doc(docId), obj);
                    });
                    await batch.commit();
                    setMessage({ text: `✅ ${target} 同步成功！\n成功將 ${dataRows.length} 筆資料寫入資料庫。`, type: 'success' });
                } catch (e) { setMessage({ text: '❌ 同步失敗。', type: 'error' }); }
                finally { setSyncing(false); }
            };

            return (
                <div className="p-6 space-y-6 h-full overflow-y-auto no-print text-left bg-slate-50 text-left">
                    <div className="flex justify-between items-center text-center">
                        <h2 className="text-xs font-black uppercase tracking-widest text-slate-400 text-left">Management Panel</h2>
                        <button onClick={() => setView('lookup')}><Icon name="LogOut" size={16} /></button>
                    </div>

                    <div className="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm text-center text-center">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 text-center text-center">與會者報到率</p>
                        <p className="text-5xl font-black tracking-tighter text-slate-800 text-center">{checkedInCount} <span className="text-xl font-bold opacity-20">/ {attendees.length}</span></p>
                    </div>

                    <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm text-left">
                        <p className="text-[10px] font-black text-slate-400 uppercase">工作人員數</p>
                        <p className="text-xl font-black text-slate-800">{workers.length}</p>
                    </div>

                    <div className="space-y-4 pt-4 text-center text-left text-left">
                        <button onClick={() => syncData('attendees', ATTENDEE_CSV_URL)} disabled={syncing} className="w-full p-4 bg-orange-50 text-orange-600 rounded-2xl font-black border border-orange-200 flex items-center justify-center gap-2 active:scale-95 text-center">
                            <Icon name={syncing ? "Loader2" : "DownloadCloud"} size={18} className={syncing ? "animate-spin" : ""} />
                            {syncing ? '同步中...' : '同步與會者名單 (gid=0)'}
                        </button>
                        <div className="bg-white p-5 rounded-3xl border border-slate-100 space-y-3 text-left">
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest text-center text-center">分頁資料同步 (Worker)</p>
                            <input type="text" placeholder="貼上分頁完整網址" className="w-full p-3 bg-slate-50 border rounded-xl text-xs outline-none focus:ring-1 focus:ring-slate-300" value={syncUrl} onChange={e => setSyncUrl(e.target.value)} />
                            <button onClick={() => syncData('workers', syncUrl)} disabled={syncing} className="w-full py-3 bg-slate-800 text-white rounded-xl text-xs font-bold active:scale-95 text-center">同步工作人員名單</button>
                        </div>
                        <button onClick={() => window.open(GOOGLE_SHEET_URL, '_blank')} className="w-full p-5 bg-[#f37021] text-white rounded-[32px] font-black flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all text-center"><Icon name="BarChart3" size={20} /> 開啟雲端試算表</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
