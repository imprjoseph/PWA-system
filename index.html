<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ–°å‹•åŠ›å…¬é—œ - ç®¡ç†èˆ‡å ±åˆ°ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/lucide-react/dist/umd/lucide-react.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fade-in 0.5s ease-out; }
    body { background-color: #0f172a; margin: 0; font-family: sans-serif; }
    #reader { width: 100% !important; border: none !important; border-radius: 1rem; overflow: hidden; }
    #reader__scan_region { background: white; }
  </style>
</head>
<body>
  <div id="root">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const Icon = ({ name, ...props }) => {
      const LucideIcon = window.LucideReact ? window.LucideReact[name] : null;
      return LucideIcon ? <LucideIcon {...props} /> : null;
    };

    function App() {
      const [db, setDb] = useState({ LIST: [], NEWS: [] });
      const [view, setView] = useState('lookup'); 
      const [user, setUser] = useState(null);
      const [input, setInput] = useState('');
      const [scanResult, setScanResult] = useState(null);
      const [isSyncing, setIsSyncing] = useState(false);
      const [scanMode, setScanMode] = useState('checkin');

      // API ç¶²å€ç¶­æŒä½ æœ€æ–°è¨­å®šçš„
      const API = "https://script.google.com/macros/s/AKfycbwBQNQ9jNCBQ0Q-ueRRwyHsKXiY2osB-AQxGNHf_TLyL_WGI2cRu6npzbdMtXA8CkY/exec";

      const loadData = () => {
        fetch(API).then(res => res.json()).then(data => {
          setDb(data);
          if(user) {
            const updatedUser = data.LIST.find(a => String(a.ID) === String(user.ID));
            if(updatedUser) setUser(updatedUser);
          }
        });
      };

      useEffect(() => { loadData(); }, []);

      const stats = useMemo(() => {
        let vTotal = 0, vIn = 0, nTotal = 0, nIn = 0;
        let mealClaimed = 0, souvenirClaimed = 0;

        db.LIST.forEach(row => {
          const lv = String(row.Level || row['ç­‰ç´š'] || '').toUpperCase();
          if (lv === 'VIP') { vTotal++; if (row['å ±åˆ°æ™‚é–“']) vIn++; }
          else { nTotal++; if (row['å ±åˆ°æ™‚é–“']) nIn++; }

          if (row['é ˜é¤æ™‚é–“']) mealClaimed++;
          if (row['ç´€å¿µå“é ˜å–æ™‚é–“']) souvenirClaimed++;
        });
        return { vTotal, vIn, nTotal, nIn, mealClaimed, souvenirClaimed, totalPeople: vTotal + nTotal };
      }, [db.LIST]);

      useEffect(() => {
        if (view === 'scanner') {
          const html5QrCode = new Html5Qrcode("reader");
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
              const found = db.LIST.find(a => String(a.ID) === decodedText);
              html5QrCode.stop(); 
              
              if (found) {
                setScanResult({ ...found, status: 'found' });
                setIsSyncing(true);
                
                fetch(API, {
                  method: 'POST',
                  body: JSON.stringify({ id: decodedText, action: scanMode }) 
                })
                .then(res => res.json())
                .then(result => {
                  setIsSyncing(false);
                  if(result.status === "success") {
                    setScanResult({ ...found, status: 'success', successMsg: result.message });
                    loadData(); 
                  } else if (result.status === "warning") {
                    setScanResult({ ...found, status: 'warning', errorMsg: result.message });
                  } else {
                    setScanResult({ ...found, status: 'error', errorMsg: 'å¯«å…¥å¤±æ•—' });
                  }
                })
                .catch(err => {
                  setIsSyncing(false);
                  setScanResult({ ...found, status: 'error', errorMsg: 'ç¶²è·¯é€£ç·šç•°å¸¸' });
                });
              } else {
                setScanResult({ Name: "æœªçŸ¥ä»£ç¢¼", ID: decodedText, status: 'not_found' });
              }
            },
            () => {}
          );
          return () => { if(html5QrCode.isScanning) html5QrCode.stop(); };
        }
      }, [view, db.LIST, scanMode]);

      // --- ç•«é¢ä¸€ï¼šå·¥ä½œäººå“¡æƒæä»‹é¢ ---
      if (view === 'scanner') {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-4 animate-fade-in flex flex-col">
            <div className="flex justify-between items-center mb-4 mt-2">
              <h1 className="text-xl font-bold flex items-center gap-2">
                <Icon name="Camera" /> ç®¡ç†å“¡æ¨¡å¼
              </h1>
              <button onClick={() => {setView('lookup'); setScanResult(null);}} className="text-slate-400">é—œé–‰</button>
            </div>

            <div className="bg-slate-800 rounded-2xl p-4 mb-4 grid grid-cols-2 gap-4 text-sm shadow-lg">
              <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                <p className="text-slate-400 mb-1 flex items-center gap-1"><Icon name="Star" size={14} className="text-amber-400"/> VIP å ±åˆ°</p>
                <p className="text-xl font-bold">{stats.vIn} <span className="text-xs text-slate-500">/ {stats.vTotal}</span></p>
              </div>
              <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                <p className="text-slate-400 mb-1 flex items-center gap-1"><Icon name="User" size={14} className="text-blue-400"/> ä¸€èˆ¬å ±åˆ°</p>
                <p className="text-xl font-bold">{stats.nIn} <span className="text-xs text-slate-500">/ {stats.nTotal}</span></p>
              </div>
              <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                <p className="text-slate-400 mb-1 flex items-center gap-1"><Icon name="Utensils" size={14} className="text-emerald-400"/> å·²ç™¼é¤é»</p>
                <p className="text-xl font-bold">{stats.mealClaimed} <span className="text-xs text-slate-500">/ {stats.totalPeople}</span></p>
              </div>
              <div className="bg-slate-700/50 p-3 rounded-xl border border-slate-600">
                <p className="text-slate-400 mb-1 flex items-center gap-1"><Icon name="Gift" size={14} className="text-purple-400"/> å·²ç™¼ç´€å¿µå“</p>
                <p className="text-xl font-bold">{stats.souvenirClaimed} <span className="text-xs text-slate-500">/ {stats.totalPeople}</span></p>
              </div>
            </div>

            {!scanResult && (
              <div className="flex bg-slate-800 p-1 rounded-xl mb-4 shadow-inner">
                <button onClick={() => setScanMode('checkin')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${scanMode === 'checkin' ? 'bg-blue-500 text-white shadow-md' : 'text-slate-400'}`}>å ±åˆ°</button>
                <button onClick={() => setScanMode('meal')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${scanMode === 'meal' ? 'bg-emerald-500 text-white shadow-md' : 'text-slate-400'}`}>é ˜é¤</button>
                <button onClick={() => setScanMode('souvenir')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${scanMode === 'souvenir' ? 'bg-purple-500 text-white shadow-md' : 'text-slate-400'}`}>ç´€å¿µå“</button>
              </div>
            )}
            
            {!scanResult ? (
              <div className={`overflow-hidden rounded-2xl border-2 shadow-[0_0_20px_rgba(0,0,0,0.3)] ${scanMode === 'checkin' ? 'border-blue-500' : scanMode === 'meal' ? 'border-emerald-500' : 'border-purple-500'}`}>
                <div id="reader"></div>
              </div>
            ) : (
              <div className="bg-white text-slate-900 p-8 rounded-3xl text-center animate-fade-in mt-auto mb-auto">
                <div className={`w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center 
                  ${scanResult.status === 'success' ? 'bg-green-100 text-green-600' : 
                    scanResult.status === 'warning' ? 'bg-yellow-100 text-yellow-600' :
                    scanResult.status === 'not_found' || scanResult.status === 'error' ? 'bg-red-100 text-red-600' : 
                    'bg-slate-100 text-slate-500'}`}>
                  {isSyncing ? <Icon name="Loader2" className="animate-spin" size={40} /> : 
                   scanResult.status === 'success' ? <Icon name="CheckCircle" size={40} /> : 
                   scanResult.status === 'warning' ? <Icon name="AlertTriangle" size={40} /> : 
                   <Icon name="XCircle" size={40} />}
                </div>
                
                <h2 className="text-2xl font-bold mb-1">{scanResult.Name}</h2>
                <div className="flex items-center justify-center gap-2 mb-2">
                  <span className={`px-2 py-0.5 rounded-md text-xs font-bold ${String(scanResult.Level).toUpperCase() === 'VIP' ? 'bg-amber-100 text-amber-600' : 'bg-blue-100 text-blue-600'}`}>
                    {scanResult.Level || 'NORMAL'}
                  </span>
                  <span className="text-slate-500">{scanResult.Company || "ç„¡å…¬å¸è³‡æ–™"}</span>
                </div>
                
                <div className="mb-6 h-6">
                  {isSyncing && <span className="text-slate-500 font-bold text-sm">è³‡æ–™åŒæ­¥ä¸­...</span>}
                  {scanResult.status === 'success' && <span className="text-green-600 font-bold text-sm">{scanResult.successMsg}</span>}
                  {scanResult.status === 'warning' && <span className="text-yellow-600 font-bold text-sm">{scanResult.errorMsg}</span>}
                  {scanResult.status === 'error' && <span className="text-red-500 font-bold text-sm">{scanResult.errorMsg}</span>}
                  {scanResult.status === 'not_found' && <span className="text-red-500 font-bold text-sm">æŸ¥ç„¡æ­¤äºº</span>}
                </div>

                <button onClick={() => setScanResult(null)} disabled={isSyncing} className={`w-full p-4 rounded-xl font-bold transition-all ${isSyncing ? 'bg-slate-200 text-slate-400' : 'bg-slate-900 text-white shadow-lg'}`}>ç¹¼çºŒæƒæ</button>
              </div>
            )}
          </div>
        );
      }

      // --- ç•«é¢äºŒï¼šèˆ‡æœƒè€…å€‹äººé é¢ ---
      if (view === 'dashboard' && user) {
        const isVip = String(user.Level || user['ç­‰ç´š'] || '').toUpperCase() === 'VIP';
        const themeBg = isVip ? 'bg-gradient-to-br from-amber-500 to-yellow-600' : 'bg-gradient-to-br from-blue-600 to-indigo-700';
        const badgeBg = isVip ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-blue-100 text-blue-700 border-blue-200';
        
        return (
          <div className="min-h-screen bg-slate-50 flex flex-col animate-fade-in pb-10">
            <div className={`p-8 ${themeBg} text-white rounded-b-[50px] shadow-lg relative z-10`}>
              <div className="flex justify-between mb-6">
                <button onClick={() => {setUser(null); setView('lookup'); setInput('');}} className="p-2 -ml-2 hover:bg-white/20 rounded-full transition"><Icon name="ArrowLeft" /></button>
                <div className="flex items-center gap-1 font-bold tracking-widest bg-white/20 px-3 py-1 rounded-full text-sm shadow-inner">
                  {isVip && <Icon name="Star" size={14} className="fill-white" />} {isVip ? 'VIP GUEST' : 'GUEST'}
                </div>
              </div>
              <h2 className="text-3xl font-black mb-1">{user.Name}</h2>
              <p className="opacity-90 font-medium text-lg">{user.Title || user['è·ç¨±']}</p>
            </div>

            <div className="px-6 -mt-8 relative z-20 flex flex-col items-center">
              <div className="w-full bg-white p-6 shadow-2xl rounded-[30px] border border-slate-50 flex flex-col items-center mb-6">
                <div className="p-3 bg-slate-50 rounded-2xl mb-3 border border-slate-100">
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${user.ID}`} className="w-40 h-40" alt="QR Code" />
                </div>
                <p className="font-bold text-slate-400 tracking-widest text-[10px]">ENTRY QR CODE</p>
              </div>

              <div className="w-full bg-white p-6 shadow-lg rounded-[30px] border border-slate-50 mb-6">
                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                  <Icon name="FileText" className="text-slate-400" size={20} /> åŸºæœ¬è³‡è¨Š
                </h3>
                <div className="space-y-3 text-sm">
                  <div className="flex justify-between items-center border-b border-slate-100 pb-2">
                    <span className="text-slate-500">æ‰€å±¬å…¬å¸</span>
                    <span className="font-bold text-slate-800 text-right">{user.Company || user['å…¬å¸'] || '-'}</span>
                  </div>
                  <div className="flex justify-between items-center border-b border-slate-100 pb-2">
                    <span className="text-slate-500">è¯çµ¡ä¿¡ç®±</span>
                    <span className="font-bold text-slate-800 text-right">{user.Email || '-'}</span>
                  </div>
                  <div className="flex justify-between items-center border-b border-slate-100 pb-2">
                    <span className="text-slate-500">é¤é»éœ€æ±‚</span>
                    <span className={`font-bold border px-2 py-0.5 rounded-md ${badgeBg}`}>
                      {user.Eating || user['é¤é»'] || 'ç„¡ç‰¹åˆ¥å‚™è¨»'}
                    </span>
                  </div>
                </div>

                <h3 className="text-lg font-bold text-slate-800 mt-6 mb-4 flex items-center gap-2">
                  <Icon name="CheckCircle" className="text-slate-400" size={20} /> é ˜å–ç‹€æ…‹
                </h3>
                <div className="grid grid-cols-2 gap-3">
                  <div className={`p-3 rounded-xl border flex flex-col items-center justify-center text-center ${user['é ˜é¤æ™‚é–“'] ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-slate-200'}`}>
                    <Icon name="Utensils" size={24} className={`mb-1 ${user['é ˜é¤æ™‚é–“'] ? 'text-emerald-500' : 'text-slate-300'}`} />
                    <span className={`font-bold text-sm ${user['é ˜é¤æ™‚é–“'] ? 'text-emerald-700' : 'text-slate-500'}`}>{user['é ˜é¤æ™‚é–“'] ? 'å·²é ˜é¤' : 'æœªé ˜é¤'}</span>
                  </div>
                  <div className={`p-3 rounded-xl border flex flex-col items-center justify-center text-center ${user['ç´€å¿µå“é ˜å–æ™‚é–“'] ? 'bg-purple-50 border-purple-200' : 'bg-slate-50 border-slate-200'}`}>
                    <Icon name="Gift" size={24} className={`mb-1 ${user['ç´€å¿µå“é ˜å–æ™‚é–“'] ? 'text-purple-500' : 'text-slate-300'}`} />
                    <span className={`font-bold text-sm ${user['ç´€å¿µå“é ˜å–æ™‚é–“'] ? 'text-purple-700' : 'text-slate-500'}`}>{user['ç´€å¿µå“é ˜å–æ™‚é–“'] ? 'å·²é ˜å–' : 'æœªé ˜å–'}</span>
                  </div>
                </div>
                <div className="mt-4 flex justify-center">
                    <button onClick={loadData} className="text-xs flex items-center gap-1 text-slate-400 bg-slate-50 px-3 py-1.5 rounded-full hover:bg-slate-100"><Icon name="RefreshCw" size={12}/> é»æ“Šé‡æ•´ç‹€æ…‹</button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // --- ç•«é¢ä¸‰ï¼šèˆ‡æœƒè€…ç™»å…¥ä»‹é¢ ---
      return (
        <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6">
          <div className="max-w-md w-full bg-white p-10 rounded-[40px] shadow-2xl animate-fade-in relative">
            
            {/* ğŸŒŸ é€™è£¡æ›æˆä½ å€‘çš„ Logo ğŸŒŸ */}
            <div className="flex justify-center mb-6">
               <img src="./logo.png" alt="æ–°å‹•åŠ›å…¬é—œ" className="h-16 w-auto object-contain" />
            </div>
            
            <h1 className="text-xl font-bold text-center mb-8 text-slate-600">æ´»å‹•å ±åˆ°ç³»çµ±</h1>
            
            <input 
              type="text" placeholder="è«‹è¼¸å…¥ Email æˆ– æ‰‹æ©Ÿè™Ÿç¢¼" 
              className="w-full p-4 mb-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition"
              value={input} onChange={e => setInput(e.target.value)}
            />
            <button onClick={() => {
              const found = db.LIST.find(a => String(a.Email) === input || String(a.Phone) === input);
              if(found) { setUser(found); setView('dashboard'); } else { alert("æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªè¼¸å…¥æ˜¯å¦æœ‰èª¤ã€‚"); }
            }} className="w-full bg-[#f37021] text-white p-4 rounded-2xl font-bold mb-4 shadow-lg shadow-orange-200 hover:bg-[#e06117] transition">ç™»å…¥æŸ¥è©¢</button>
            
            <button onClick={() => setView('scanner')} className="w-full border-2 border-slate-100 text-slate-400 p-4 rounded-2xl font-bold flex items-center justify-center gap-2 mt-4 hover:bg-slate-50 transition">
              <Icon name="Lock" size={16} /> å·¥ä½œäººå“¡å…¥å£
            </button>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
