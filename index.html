<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新動力公關 - 活動管理系統</title>
    
    <!-- 基礎套件載入 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 圖示與掃描器 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .scan-line {
            position: absolute; width: 100%; height: 2px;
            background: #f37021; box-shadow: 0 0 10px #f37021;
            animation: scan 2s linear infinite;
        }

        /* 列印設定 (60x40mm) */
        @media print {
            body, html { margin: 0; padding: 0; background: white !important; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            @page { size: 60mm 40mm; margin: 0; }
            .label-container {
                width: 60mm; height: 40mm; padding: 4mm;
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                text-align: center; box-sizing: border-box; page-break-after: always;
            }
            .label-header { font-size: 8pt; font-weight: bold; color: #666; margin-bottom: 2mm; border-bottom: 1px solid #f37021; width: 100%; }
            .label-name { font-size: 20pt; font-weight: 900; margin-bottom: 1mm; color: black; }
            .label-info { font-size: 9pt; font-weight: bold; color: #333; }
        }
        @media screen { .print-only { display: none; } }
        
        #reader { border: none !important; border-radius: 1.5rem; overflow: hidden; }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Firebase 配置 ---
        const customConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        let firebaseConfig;
        try {
            firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) 
                ? JSON.parse(__firebase_config) 
                : customConfig;
        } catch (e) {
            firebaseConfig = customConfig;
        }

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'impr-event-pwa-production';

        const SHEET_ID = "1oZNmnM9ofMbYY9vcATltOg0IORcBSX2H5Txk9M9_7so";
        const ATTENDEE_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
        const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`;

        // --- 標籤設定 ---
        const LABEL_CONFIG = { width: "60mm", height: "40mm", padding: "4mm" };

        // --- 穩定圖示組件 ---
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={`inline-block align-middle ${className}`}></i>;
        };

        // --- 品牌 Logo (修復版) ---
        const BrandLogo = ({ className = "w-full", invert = false }) => {
            const color = invert ? "#ffffff" : "#f37021";
            return (
                <div className={`flex items-center justify-center ${className}`}>
                    <svg viewBox="0 0 600 160" xmlns="http://www.w3.org/2000/svg" className="w-full h-auto">
                        {/* 符號部分 */}
                        <circle cx="50" cy="55" r="30" fill="none" stroke={color} strokeWidth="10" />
                        <line x1="50" y1="35" x2="50" y2="65" stroke={color} strokeWidth="10" strokeLinecap="round" />
                        
                        {/* 文字部分 - IMPR */}
                        <text x="100" y="85" fill={color} style={{ fontWeight: '900', fontSize: '100px', fontFamily: 'Arial Black, sans-serif' }}>impr</text>
                        
                        {/* 分隔線與中文名稱 */}
                        <line x1="20" y1="110" x2="580" y2="110" stroke={color} strokeWidth="3" />
                        <text x="30" y="140" fill={color} style={{ fontWeight: '900', fontSize: '24px' }}>新動力公共關係顧問股份有限公司</text>
                        <text x="400" y="140" fill={color} style={{ fontWeight: '700', fontSize: '12px', fontFamily: 'Arial' }}>Consultants Co., Ltd.</text>
                    </svg>
                </div>
            );
        };

        const checkIsVIP = (data) => {
            if (!data) return false;
            const level = String(data.LEVEL || data.level || data['等級'] || '').trim().toUpperCase();
            return level === 'VIP';
        };

        // --- CSV 解析 ---
        const parseCSV = (text) => {
            const rows = []; let currentRow = []; let currentCell = ''; let insideQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i]; const nextChar = text[i + 1];
                if (char === '"') { if (insideQuote && nextChar === '"') { currentCell += '"'; i++; } else { insideQuote = !insideQuote; } }
                else if (char === ',' && !insideQuote) { currentRow.push(currentCell.trim()); currentCell = ''; }
                else if ((char === '\n' || char === '\r') && !insideQuote) {
                    if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
                    currentRow = []; currentCell = ''; if (char === '\r' && nextChar === '\n') i++;
                } else { currentCell += char; }
            }
            if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
            return rows;
        };

        // --- 主程式 App ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('lookup');
            const [currentUserData, setCurrentUserData] = useState(null);
            const [attendees, setAttendees] = useState([]);
            const [workers, setWorkers] = useState([]);
            const [claims, setClaims] = useState([]);
            const [news, setNews] = useState([]);
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState({ text: '', type: '' });

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error("Auth Fail", e); }
                };
                const unsubAuth = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                });
                initAuth();
                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const dataRef = db.collection('artifacts').doc(appId).collection('public').doc('data');
                const unsubA = dataRef.collection('attendees').onSnapshot(s => setAttendees(s.docs.map(d => ({id: d.id, ...d.data()}))), e => console.error(e));
                const unsubW = dataRef.collection('workers').onSnapshot(s => setWorkers(s.docs.map(d => ({id: d.id, ...d.data()}))), e => console.error(e));
                const unsubC = dataRef.collection('claims').onSnapshot(s => setClaims(s.docs.map(d => ({id: d.id, ...d.data()}))), e => console.error(e));
                const unsubN = dataRef.collection('news').onSnapshot(s => setNews(s.docs.map(d => ({id: d.id, ...d.data()}))), e => console.error(e));
                return () => { unsubA(); unsubW(); unsubC(); unsubN(); };
            }, [user]);

            const handleLookup = (input) => {
                const term = input.trim().toLowerCase();
                if (!term) return;
                const match = attendees.find(a => 
                    String(a.Email || a.email || '').toLowerCase() === term ||
                    String(a.Phone || a.phone || '').replace(/[-\s]/g, '') === term.replace(/[-\s]/g, '') ||
                    String(a.ID || a.id || '').toLowerCase() === term
                );
                if (match) {
                    setCurrentUserData(match);
                    setView('user-dashboard');
                } else if (term === 'joseph@impr.com.tw') {
                    setCurrentUserData({ id: 'JOSEPH', Name: 'Joseph Huang', Company: 'IMPR', Title: 'GM', LEVEL: 'VIP' });
                    setView('user-dashboard');
                } else {
                    setMessage({ text: '查無資料，請確認輸入是否正確。', type: 'error' });
                }
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-white"><BrandLogo className="w-48 animate-pulse" /></div>;

            return (
                <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative flex flex-col overflow-hidden">
                    {view === 'lookup' && <Lookup onLogin={handleLookup} setView={setView} BrandLogo={BrandLogo} />}
                    {view === 'staff-login' && <StaffLogin workers={workers} setView={setView} setCurrentUserData={setCurrentUserData} BrandLogo={BrandLogo} />}
                    {view === 'user-dashboard' && <UserDashboard data={currentUserData} claims={claims} news={news} setView={setView} BrandLogo={BrandLogo} />}
                    {view === 'staff-tool' && <StaffTool user={currentUserData} attendees={attendees} setView={setView} BrandLogo={BrandLogo} db={db} appId={appId} />}
                    {view === 'admin-panel' && <AdminPanel attendees={attendees} workers={workers} claims={claims} setView={setView} setMessage={setMessage} db={db} appId={appId} parseCSV={parseCSV} ATTENDEE_CSV_URL={ATTENDEE_CSV_URL} GOOGLE_SHEET_URL={GOOGLE_SHEET_URL} />}
                    
                    {message.text && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/40 backdrop-blur-sm no-print">
                            <div className="bg-white rounded-[32px] w-full max-w-xs p-8 shadow-2xl text-center scale-in-center">
                                <div className={`w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center ${message.type === 'error' ? 'bg-red-50 text-red-500' : 'bg-blue-50 text-blue-500'}`}>
                                    <Icon name={message.type === 'error' ? "x-circle" : "info"} />
                                </div>
                                <p className="font-bold text-slate-800 mb-6">{message.text}</p>
                                <button onClick={() => setMessage({text: '', type: ''})} className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold uppercase">確定</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 子組件：與會者登入 ---
        function Lookup({ onLogin, setView, BrandLogo }) {
            const [val, setVal] = useState('');
            return (
                <div className="p-10 flex flex-1 flex-col items-center justify-center text-center">
                    <BrandLogo className="mb-10 w-56" />
                    <h1 className="text-xl font-black mb-2 tracking-tight">活動報到查詢</h1>
                    <p className="text-slate-400 text-sm mb-8 px-4 leading-relaxed italic">請輸入 Email、手機或 ID 碼</p>
                    <input type="text" placeholder="Email / 手機號碼" className="w-full p-4 bg-slate-50 rounded-2xl border mb-4 text-center outline-none focus:ring-2 focus:ring-orange-500" value={val} onChange={e => setVal(e.target.value)} onKeyPress={e => e.key === 'Enter' && onLogin(val)} />
                    <button onClick={() => onLogin(val)} className="w-full bg-[#f37021] text-white p-4 rounded-2xl font-black shadow-lg shadow-orange-100 hover:bg-orange-600 active:scale-95 transition-all">登入查詢</button>
                    <button onClick={() => setView('staff-login')} className="mt-12 text-slate-300 text-xs font-bold hover:text-orange-500 flex items-center gap-1 justify-center">
                        <Icon name="lock" size={14} /> 工作人員入口
                    </button>
                </div>
            );
        }

        // --- 子組件：工作人員登入 (修正：帳號與密碼) ---
        function StaffLogin({ workers, setView, setCurrentUserData, BrandLogo }) {
            const [acc, setAcc] = useState('');
            const [pw, setPw] = useState('');
            
            const login = () => {
                const inputAcc = acc.trim();
                const inputPw = pw.trim();
                
                // 比對 logic: 支援中文標頭 "帳號" / "密碼" 或英文 "Account" / "Passwd"
                const found = workers.find(w => 
                    (String(w['帳號'] || w['Account'] || '') === inputAcc) && 
                    (String(w['密碼'] || w['Passwd'] || '') === inputPw)
                );
                
                if (found || (inputAcc === 'admin' && inputPw === 'admin123')) {
                    const user = found || { Name: '系統管理員', LEVEL: 'admin', ['姓名']: '管理員' };
                    setCurrentUserData(user);
                    setView(String(user.LEVEL || user.level || '').toLowerCase() === 'admin' ? 'admin-panel' : 'staff-tool');
                } else {
                    alert("驗證失敗：帳號或密碼不正確。");
                }
            };

            return (
                <div className="p-10 flex flex-1 flex-col items-center justify-center bg-slate-50">
                    <BrandLogo className="mb-10 w-44" />
                    <h2 className="text-lg font-black mb-6 flex items-center gap-2 border-b-2 border-orange-500 pb-1">後台管理登入</h2>
                    <div className="w-full space-y-4">
                        <input type="text" placeholder="帳號 Account" className="w-full p-4 bg-white rounded-2xl border outline-none focus:ring-2 focus:ring-slate-800 shadow-sm" value={acc} onChange={e => setAcc(e.target.value)} />
                        <input type="password" placeholder="密碼 Password" className="w-full p-4 bg-white rounded-2xl border outline-none focus:ring-2 focus:ring-slate-800 shadow-sm" value={pw} onChange={e => setPw(e.target.value)} />
                        <button onClick={login} className="w-full bg-slate-900 text-white p-4 rounded-2xl font-black shadow-lg active:scale-95 transition-all">登入 Login</button>
                    </div>
                    <button onClick={() => setView('lookup')} className="mt-8 text-slate-400 text-xs font-bold hover:text-slate-600 underline">返回首頁</button>
                </div>
            );
        }

        // --- 子組件：與會者個人頁面 ---
        function UserDashboard({ data, claims, news, setView, BrandLogo }) {
            const [tab, setTab] = useState('profile');
            const isVIP = checkIsVIP(data);
            const isC = (type) => claims.some(c => c.attendeeId === data.id && c.item === type);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data.id || data.Email || '')}`;

            return (
                <div className="flex flex-col h-full bg-slate-50 overflow-hidden">
                    <div className="print-only">
                        <div className="label-container">
                            <div className="label-header">{isVIP ? "VIP 貴賓" : "與會嘉賓"}</div>
                            <div className="label-name">{data.Name || data.name || data['姓名']}</div>
                            <div className="label-info">{data.Company || data.company || data['公司']}</div>
                            <div className="label-info">{data.Title || data.title || data['職稱']}</div>
                        </div>
                    </div>
                    <div className="no-print flex flex-col h-full overflow-hidden">
                        <div className={`${isVIP ? 'bg-gradient-to-br from-amber-500 to-orange-600' : 'bg-blue-800'} p-6 text-white pb-12 shadow-xl`}>
                            <div className="flex justify-between items-center mb-6">
                                <BrandLogo invert className="w-28" />
                                <button onClick={() => setView('lookup')} className="p-2 bg-white/20 rounded-lg"><Icon name="log-out" size={18}/></button>
                            </div>
                            <div className="flex items-center gap-5 text-left">
                                <div className="w-20 h-20 bg-white rounded-3xl flex items-center justify-center text-slate-800 shadow-2xl shrink-0">
                                    {isVIP ? <Icon name="medal" size={40} className="text-amber-500"/> : <Icon name="user" size={40} className="text-blue-700"/>}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <h2 className="text-2xl font-black truncate">{data.Name || data.name || data['姓名']}</h2>
                                    <p className="text-xs font-bold opacity-90 truncate">{data.Company || data.company || data['公司']}</p>
                                    <p className="text-[10px] opacity-70 truncate uppercase tracking-widest">{data.Title || data.title || data['職稱']}</p>
                                </div>
                            </div>
                        </div>
                        <div className="flex bg-white mx-5 -mt-6 rounded-2xl shadow-xl p-1 shrink-0 z-10">
                            <button onClick={() => setTab('profile')} className={`flex-1 py-3 text-xs font-black rounded-xl transition-all ${tab === 'profile' ? 'bg-orange-50 text-orange-600' : 'text-slate-300'}`}>專屬憑證</button>
                            <button onClick={() => setTab('agenda')} className={`flex-1 py-3 text-xs font-black rounded-xl transition-all ${tab === 'agenda' ? 'bg-orange-50 text-orange-600' : 'text-slate-300'}`}>大會公告</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {tab === 'profile' && (
                                <>
                                    <div className="bg-white p-6 rounded-[40px] flex flex-col items-center shadow-sm border border-slate-100">
                                        <div className="p-3 bg-slate-50 rounded-3xl mb-4 border border-slate-100"><img src={qrUrl} className="w-44 h-44" alt="QR" /></div>
                                        <button onClick={() => window.print()} className="flex items-center gap-2 px-8 py-3 bg-slate-900 text-white rounded-full text-xs font-black shadow-lg active:scale-95 transition-all"><Icon name="printer" size={16}/> 列印實體標籤</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className={`p-5 rounded-3xl border transition-all text-center ${isC('meal') ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                                            <Icon name="utensils" size={24} className={isC('meal') ? 'text-green-500' : 'text-slate-200'} />
                                            <p className={`text-[10px] font-black mt-2 ${isC('meal') ? 'text-green-700' : 'text-slate-400'}`}>{isC('meal') ? '餐點已領取' : '餐點未領取'}</p>
                                        </div>
                                        <div className={`p-5 rounded-3xl border transition-all text-center ${isC('gift') ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                                            <Icon name="gift" size={24} className={isC('gift') ? 'text-green-500' : 'text-slate-200'} />
                                            <p className={`text-[10px] font-black mt-2 ${isC('gift') ? 'text-green-700' : 'text-slate-400'}`}>{isC('gift') ? '贈品已領取' : '贈品未領取'}</p>
                                        </div>
                                    </div>
                                </>
                            )}
                            {tab === 'agenda' && (
                                <div className="space-y-4">
                                    {news.length > 0 ? news.map((n, i) => (
                                        <div key={i} className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm text-left">
                                            <div className="flex items-center gap-2 mb-2"><Icon name="bell" size={14} className="text-orange-500" /><p className="text-xs font-black text-orange-600 uppercase">{n.Title || n.title || n['標題']}</p></div>
                                            <p className="text-xs text-slate-500 leading-relaxed font-medium">{n.Content || n.content || n['內容']}</p>
                                        </div>
                                    )) : <div className="text-center py-20 text-slate-300 font-bold italic">目前尚無大會公告</div>}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- 子組件：工作人員工具 (掃描) ---
        function StaffTool({ user, attendees, setView, db, appId }) {
            const [scanRes, setScanRes] = useState(null);
            const scannerRef = useRef(null);

            useEffect(() => {
                if (!scanRes && window.Html5QrcodeScanner) {
                    const scanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
                    scanner.render((txt) => {
                        const m = attendees.find(a => String(a.id || a.ID) === txt || String(a.Email || a.email || '').toLowerCase() === txt.toLowerCase());
                        if (m) { setScanRes(m); scanner.clear().catch(() => {}); }
                    }, () => {});
                    scannerRef.current = scanner;
                    return () => { if (scannerRef.current) scannerRef.current.clear().catch(() => {}); };
                }
            }, [scanRes, attendees]);

            const claim = async (type) => {
                const id = scanRes.id || scanRes.ID;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('claims').doc(`${type}_${id}`).set({
                    attendeeId: id, item: type, timestamp: new Date().toISOString(), staff: user.Name || user['姓名'] || 'Staff'
                });
                alert("核銷成功！");
                setScanRes(null);
            };

            return (
                <div className="flex flex-col h-full bg-slate-900 text-white p-6 no-print">
                    <div className="flex justify-between items-center mb-8">
                        <div className="flex items-center gap-2"><Icon name="camera" size={18} className="text-orange-500" /><h2 className="text-xs font-bold tracking-widest text-orange-400 uppercase">QR 核銷系統</h2></div>
                        <button onClick={() => setView('lookup')} className="text-xs font-bold opacity-40">結束作業</button>
                    </div>
                    {!scanRes ? (
                        <div className="flex flex-col items-center flex-1 justify-center">
                            <div id="reader" className="w-full bg-black rounded-[40px] overflow-hidden border-2 border-white/5 aspect-square shadow-2xl relative">
                                <div className="scan-line"></div>
                            </div>
                            <p className="mt-8 text-xs text-slate-500 animate-pulse font-black tracking-[0.3em] uppercase">Ready to Scan</p>
                        </div>
                    ) : (
                        <div className="bg-white p-8 rounded-[48px] text-slate-900 animate-in zoom-in duration-300 shadow-2xl text-left">
                            <div className="inline-block px-3 py-1 rounded-full text-[10px] font-black mb-4 uppercase bg-orange-100 text-orange-600">{scanRes.LEVEL || scanRes['等級'] || 'GUEST'}</div>
                            <h3 className="text-3xl font-black mb-1">{scanRes.Name || scanRes['姓名']}</h3>
                            <p className="text-xs font-bold text-slate-400 mb-8 border-b pb-4">{scanRes.Company || scanRes['公司']}</p>
                            <div className="space-y-4">
                                <button onClick={() => claim('meal')} className="w-full py-5 bg-orange-600 text-white rounded-3xl font-black shadow-lg">發放餐點</button>
                                <button onClick={() => claim('gift')} className="w-full py-5 bg-slate-900 text-white rounded-3xl font-black shadow-lg">發放紀念品</button>
                                <button onClick={() => setScanRes(null)} className="w-full py-3 text-slate-300 text-xs font-bold uppercase text-center">取消並重掃</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 子組件：管理者中心 ---
        function AdminPanel({ attendees, workers, claims, setView, setMessage, db, appId, parseCSV, ATTENDEE_CSV_URL, GOOGLE_SHEET_URL }) {
            const [syncing, setSyncing] = useState(false);
            const [syncUrl, setSyncUrl] = useState('');
            const checkedInCount = useMemo(() => (new Set(claims.map(c => c.attendeeId))).size, [claims]);

            const syncData = async (target, url) => {
                setSyncing(true);
                try {
                    const csvUrl = url.includes('/edit') ? url.replace('/edit', '/export?format=csv') : url;
                    const res = await fetch(csvUrl);
                    const text = await res.text();
                    const rows = parseCSV(text);
                    const head = rows[0];
                    const data = rows.slice(1);
                    const batch = db.batch();
                    data.forEach(r => {
                        const obj = {}; head.forEach((h, i) => obj[h.trim()] = r[i] || "");
                        const rawId = obj.ID || obj.id || obj.Email || obj.email || "";
                        const docId = rawId.toLowerCase().trim() || `ID_${Math.random().toString(36).slice(2, 7)}`;
                        batch.set(db.collection('artifacts').doc(appId).collection('public').doc('data').collection(target).doc(docId), obj);
                    });
                    await batch.commit();
                    setMessage({ text: `✅ ${target} 同步成功！\n更新了 ${data.length} 筆資料。`, type: 'success' });
                } catch (e) { setMessage({ text: '❌ 同步失敗，請確認網址是否包含 gid 且設為公開。', type: 'error' }); }
                finally { setSyncing(false); }
            };

            return (
                <div className="p-6 space-y-6 h-full overflow-y-auto no-print text-left bg-slate-50">
                    <div className="flex justify-between items-center"><h2 className="text-xs font-black uppercase tracking-widest text-slate-400">Admin Control</h2><button onClick={() => setView('lookup')}><Icon name="log-out" size={16} /></button></div>
                    <div className="bg-white p-8 rounded-[40px] border border-slate-100 shadow-sm text-center">
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">現場總報到率</p>
                        <p className="text-5xl font-black tracking-tighter text-slate-800">{checkedInCount} <span className="text-xl font-bold opacity-20">/ {attendees.length}</span></p>
                    </div>
                    <div className="space-y-4 pt-4">
                        <button onClick={() => syncData('attendees', ATTENDEE_CSV_URL)} disabled={syncing} className="w-full p-4 bg-orange-50 text-orange-600 rounded-2xl font-black border border-orange-200 flex items-center justify-center gap-2">
                           <Icon name="download-cloud" size={18} /> 同步與會者名單 (gid=0)
                        </button>
                        <div className="bg-white p-5 rounded-3xl border border-slate-100 space-y-3">
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">分頁同步 (Worker / NEWS)</p>
                            <input type="text" placeholder="貼上 Google Sheet 分頁網址 (含 gid)" className="w-full p-3 bg-slate-50 border rounded-xl text-xs outline-none focus:ring-1 focus:ring-slate-300" value={syncUrl} onChange={e => setSyncUrl(e.target.value)} />
                            <div className="flex gap-2">
                                <button onClick={() => syncData('workers', syncUrl)} disabled={syncing} className="flex-1 py-3 bg-slate-800 text-white rounded-xl text-xs font-bold active:scale-95">同步工作人員</button>
                                <button onClick={() => syncData('news', syncUrl)} disabled={syncing} className="flex-1 py-3 bg-blue-600 text-white rounded-xl text-xs font-bold active:scale-95">同步公告消息</button>
                            </div>
                        </div>
                        <button onClick={() => window.open(GOOGLE_SHEET_URL, '_blank')} className="w-full p-5 bg-[#f37021] text-white rounded-[32px] font-black flex items-center justify-center gap-3 shadow-xl shadow-orange-200 active:scale-95 transition-all"><Icon name="external-link" size={20} /> 開啟雲端試算表</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
