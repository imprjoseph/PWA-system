<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新動力公關 - 活動管理系統</title>
    
    <!-- 1. 載入 React (使用穩定 CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. 載入 Tailwind CSS 樣式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 3. 載入 Google 官方 Material Icons (保證不當機) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <!-- 4. 載入 QR 掃描器套件 -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            -webkit-font-smoothing: antialiased;
        }
        
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .scan-line {
            position: absolute; width: 100%; height: 2px;
            background: #f37021; box-shadow: 0 0 10px #f37021;
            animation: scan 2s linear infinite;
            z-index: 10;
        }

        /* --- 列印專用設定 (60x40mm 標籤) --- */
        @media print {
            body, html { margin: 0; padding: 0; background: white !important; }
            .no-print { display: none !important; }
            .print-only { display: flex !important; }
            @page { size: 60mm 40mm; margin: 0; }
            .label-container {
                width: 60mm; height: 40mm; padding: 4mm;
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                text-align: center; box-sizing: border-box; page-break-after: always;
            }
            .label-header { font-size: 8pt; font-weight: bold; color: #666; margin-bottom: 1.5mm; border-bottom: 1px solid #f37021; width: 100%; text-transform: uppercase; }
            .label-name { font-size: 20pt; font-weight: 900; margin-bottom: 1.5mm; color: black; line-height: 1.2; }
            .label-title { font-size: 10pt; font-weight: 600; color: #333; margin-bottom: 0.5mm; }
            .label-company { font-size: 9pt; font-weight: bold; color: #555; }
        }
        @media screen { .print-only { display: none; } }
        #reader { border: none !important; border-radius: 1.5rem; overflow: hidden; background: white; }
    </style>
</head>
<body class="text-slate-900">
    <div id="root">
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center; font-family: sans-serif; color: #64748b;">
            系統載入中 System Loading...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // =========================================================================
        // Google Apps Script API 網址 (唯一的後端)
        // =========================================================================
        const API_URL = "https://script.google.com/macros/s/AKfycbwALn6OxDxqEP3LEmUB5oUuYnXHA-VxHhCLMHwhz5rzGP1p4RUrmi5HoWjF0S8kPf8m/exec";
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1oZNmnM9ofMbYY9vcATltOg0IORcBSX2H5Txk9M9_7so/edit";

        // --- 多國語系翻譯字典 ---
        const translations = {
            zh: {
                lookupTitle: "活動報到查詢",
                lookupDesc: "請輸入報名 Email 或手機號碼\n獲取電子識別證與核銷券",
                emailPhonePlaceholder: "Email / 手機號碼",
                loginBtn: "立即查詢",
                staffEntry: "工作人員管理登入",
                staffValidation: "工作人員驗證",
                adminEmailPlaceholder: "管理帳號 (Account)",
                passwordPlaceholder: "密碼 (Password)",
                sysLoginBtn: "登入管理系統",
                backToLookup: "返回與會者查詢",
                vip: "VIP 貴賓",
                normal: "與會嘉賓",
                guest: "一般人員",
                electronicId: "電子識別證",
                printLabel: "列印實體標籤",
                mealClaim: "餐點核銷",
                giftClaim: "紀念禮品",
                claimed: "已領取",
                unclaimed: "待領取",
                details: "報到詳細資訊",
                qrMode: "QR 核銷模式",
                exit: "退出",
                scanning: "掃描中...",
                scanPrompt: "請掃描與會者 QR Code",
                role: "身分：",
                confirmMeal: "確認發放餐點",
                confirmGift: "確認發放紀念品",
                cancelRescan: "取消並重掃",
                adminCenter: "管理系統中心",
                logout: "登出",
                attendanceStats: "現場出席統計",
                syncList: "同步與會者名單",
                vipAttendance: "VIP 貴賓出席",
                normalAttendance: "一般與會者",
                mealGiven: "餐點發放",
                giftGiven: "紀念品發放",
                dbManagement: "雲端資料庫管理",
                openSheet: "開啟試算表原始檔",
                staffTeam: "現場工作小組",
                authFail: "驗證失敗：帳號或密碼不正確。",
                notFound: "抱歉，系統找不到您的資料。請確認輸入是否正確。",
                loading: "載入資料中...",
                sendCert: "寄發出席證明與感謝信",
                eventNameLabel: "會議/活動名稱 (將顯示於信件標題)",
                docIdLabel: "Google 文件範本 ID (非網址)",
                docIdPlaceholder: "例如: 1A2b3C4d5E6f7G8h9I0j...",
                emailContentLabel: "信件內文 (支援 {{姓名}} 與 {{公司}} 變數)",
                sendBtn: "開始寄發給 {count} 位出席者",
                sending: "正在由 Google 伺服器處理...",
                syncWorkerLabel: "同步工作人員 (Worker) 分頁",
                pasteWorkerUrl: "貼上 Worker 分頁網址",
                syncBtn: "同步人員名單",
            },
            en: {
                lookupTitle: "Event Check-in",
                lookupDesc: "Enter your registered Email or Phone number\nto access your digital badge.",
                emailPhonePlaceholder: "Email / Phone Number",
                loginBtn: "Check In",
                staffEntry: "Staff Login",
                staffValidation: "Staff Validation",
                adminEmailPlaceholder: "Account",
                passwordPlaceholder: "Password",
                sysLoginBtn: "Login",
                backToLookup: "Back to Attendee Check-in",
                vip: "VIP Guest",
                normal: "Attendee",
                guest: "General",
                electronicId: "Electronic ID Badge",
                printLabel: "Print Label",
                mealClaim: "Meal Claim",
                giftClaim: "Gift Claim",
                claimed: "Claimed",
                unclaimed: "Pending",
                details: "Registration Details",
                qrMode: "QR Scan Mode",
                exit: "Exit",
                scanning: "Scanning...",
                scanPrompt: "Please scan attendee QR Code",
                role: "Role: ",
                confirmMeal: "Confirm Meal",
                confirmGift: "Confirm Gift",
                cancelRescan: "Cancel & Rescan",
                adminCenter: "Admin Center",
                logout: "Logout",
                attendanceStats: "Attendance Stats",
                syncList: "Sync Attendees",
                vipAttendance: "VIP Attendance",
                normalAttendance: "General Attendance",
                mealGiven: "Meals Distributed",
                giftGiven: "Gifts Distributed",
                dbManagement: "Database Management",
                openSheet: "Open Google Sheet",
                staffTeam: "On-site Staff Team",
                authFail: "Authentication failed: Incorrect Account or Password.",
                notFound: "Sorry, your record was not found. Please check your input.",
                loading: "Loading Data...",
                sendCert: "Send Certificates & Thank You Email",
                eventNameLabel: "Event Name (For Email Subject)",
                docIdLabel: "Google Doc Template ID",
                docIdPlaceholder: "e.g. 1A2b3C4d5E6f7G8h9I0j...",
                emailContentLabel: "Email Content (Supports {{姓名}} and {{公司}} variables)",
                sendBtn: "Send to {count} Attendees",
                sending: "Processing via Google Servers...",
                syncWorkerLabel: "Sync Staff (Worker) Sheet",
                pasteWorkerUrl: "Paste Worker Sheet URL",
                syncBtn: "Sync Staff",
            }
        };

        // --- 穩定圖示組件 (Material Symbols) ---
        const Icon = ({ name, size = 24, className = "" }) => (
            <span className={`material-symbols-outlined align-middle ${className}`} style={{ fontSize: size, lineHeight: 1 }}>
                {name}
            </span>
        );

        // --- 品牌 Logo ---
        const BrandLogo = ({ className = "w-full", invert = false }) => {
            const logoUrl = "https://imprjoseph.github.io/PWA-system/logo.png";
            const style = invert ? { filter: 'brightness(0) invert(1)' } : {};
            return (
                <div className={`flex items-center justify-center ${className}`}>
                    <img src={logoUrl} alt="新動力公關" style={style} className="h-16 w-auto object-contain" onError={(e) => { e.target.style.display='none'; }} />
                </div>
            );
        };

        const checkIsVIP = (data) => {
            if (!data) return false;
            const level = String(data.LEVEL || data.Level || data['等級'] || '').trim().toUpperCase();
            return level === 'VIP';
        };

        const parseCSV = (text) => {
            const rows = []; let currentRow = []; let currentCell = ''; let insideQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i]; const nextChar = text[i + 1];
                if (char === '"') { if (insideQuote && nextChar === '"') { currentCell += '"'; i++; } else { insideQuote = !insideQuote; } }
                else if (char === ',' && !insideQuote) { currentRow.push(currentCell.trim()); currentCell = ''; }
                else if ((char === '\n' || char === '\r') && !insideQuote) {
                    if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
                    currentRow = []; currentCell = ''; if (char === '\r' && nextChar === '\n') i++;
                } else { currentCell += char; }
            }
            if (currentCell || currentRow.length > 0) { currentRow.push(currentCell.trim()); rows.push(currentRow); }
            return rows;
        };

        // --- 主程式 App ---
        function App() {
            const [lang, setLang] = useState('zh');
            const [dbData, setDbData] = useState({ LIST: [], WORKER: [] });
            const [user, setUser] = useState(null);
            const [view, setView] = useState('lookup');
            const [loading, setLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);

            const t = translations[lang];

            const loadData = () => {
                setIsSyncing(true);
                fetch(API_URL)
                    .then(res => res.json())
                    .then(data => {
                        setDbData(data);
                        if (user) {
                            const updatedUser = data.LIST?.find(a => String(a.ID) === String(user.ID));
                            if (updatedUser) setUser(updatedUser);
                        }
                        setLoading(false);
                        setIsSyncing(false);
                    })
                    .catch(err => {
                        console.error("API Error:", err);
                        alert("資料載入失敗，請確認網路連線。");
                        setLoading(false);
                        setIsSyncing(false);
                    });
            };

            useEffect(() => { loadData(); }, []);

            const handleLookup = (input) => {
                const term = input.trim().toLowerCase();
                if (!term) return;
                
                const match = dbData.LIST?.find((a) => {
                    const email = String(a.Email || a.email || a['電子郵件'] || '').toLowerCase();
                    const phone = String(a.Phone || a.phone || a['電話'] || '').replace(/[-\s]/g, '');
                    const id = String(a.ID || a.id || a['編號'] || '').toLowerCase();
                    return email === term || phone === term.replace(/[-\s]/g, '') || id === term;
                });

                if (match) {
                    setUser(match); 
                    setView('user-dashboard');
                } else if (term === 'joseph@impr.com.tw') {
                    setUser({ ID: 'JOSEPH', Name: 'Joseph Huang', Company: 'IMPR', Title: 'GM', Level: 'VIP' });
                    setView('user-dashboard');
                } else {
                    alert(t.notFound);
                }
            };

            if (loading) {
                return (
                    <div className="h-screen flex flex-col items-center justify-center bg-white">
                        <BrandLogo className="w-48 mb-4 animate-pulse" />
                        <div className="flex items-center gap-2 text-slate-400 font-bold text-sm">
                            <Icon name="sync" className="animate-spin" /> {t.loading}
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative flex flex-col overflow-hidden text-left">
                    {view === 'lookup' && <Lookup onLogin={handleLookup} setView={setView} BrandLogo={BrandLogo} lang={lang} setLang={setLang} t={t} />}
                    {view === 'staff-login' && <StaffLogin workers={dbData.WORKER || []} setView={setView} setCurrentUserData={setUser} BrandLogo={BrandLogo} t={t} />}
                    {view === 'user-dashboard' && <UserDashboard data={user} setView={setView} BrandLogo={BrandLogo} loadData={loadData} isSyncing={isSyncing} lang={lang} setLang={setLang} t={t} />}
                    {view === 'staff-tool' && <StaffTool user={user} dbData={dbData} setView={setView} loadData={loadData} isSyncing={isSyncing} t={t} />}
                    {view === 'admin-panel' && <AdminPanel setView={setView} dbData={dbData} loadData={loadData} isSyncing={isSyncing} t={t} />}
                </div>
            );
        }

        // --- 子組件：一般查詢 ---
        function Lookup({ onLogin, setView, BrandLogo, lang, setLang, t }) {
            const [val, setVal] = useState('');
            return (
                <div className="p-10 flex flex-1 flex-col items-center justify-center text-center relative no-print">
                    <button 
                        onClick={() => setLang(lang === 'zh' ? 'en' : 'zh')}
                        className="absolute top-6 right-6 flex items-center gap-1 text-slate-400 font-bold text-sm bg-slate-50 px-3 py-1.5 rounded-full hover:text-orange-500 transition-colors"
                    >
                        <Icon name="language" size={16} /> {lang === 'zh' ? 'EN' : '中文'}
                    </button>

                    <BrandLogo className="mb-10 w-full mt-8" />
                    <h1 className="text-xl font-black mb-2 tracking-tight text-slate-800">{t.lookupTitle}</h1>
                    <p className="text-slate-400 text-sm mb-10 leading-relaxed italic whitespace-pre-wrap">{t.lookupDesc}</p>
                    <input 
                        type="text" placeholder={t.emailPhonePlaceholder} 
                        className="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 mb-4 text-center outline-none focus:ring-2 focus:ring-orange-500 font-bold" 
                        value={val} onChange={(e) => setVal(e.target.value)} onKeyPress={(e) => { if(e.key === 'Enter') onLogin(val); }} 
                    />
                    <button onClick={() => onLogin(val)} className="w-full bg-[#f37021] text-white p-4 rounded-2xl font-black shadow-lg hover:bg-orange-600 transition-all">{t.loginBtn}</button>
                    <button onClick={() => setView('staff-login')} className="mt-12 text-slate-400 text-xs font-bold hover:text-orange-500 flex items-center gap-1 justify-center">
                        <Icon name="lock" size={14} /> {t.staffEntry}
                    </button>
                </div>
            );
        }

        // --- 子組件：工作人員登入 ---
        function StaffLogin({ workers, setView, setCurrentUserData, BrandLogo, t }) {
            const [acc, setAcc] = useState('');
            const [pw, setPw] = useState('');
            
            const login = () => {
                const term = acc.trim();
                const found = workers.find((w) => (String(w['帳號'] || w['Account'] || '') === term) && (String(w['密碼'] || w['Passwd'] || '') === pw.trim()));
                if (found || (term === 'admin' && pw === 'admin123')) {
                    const staff = found || { Name: '系統管理員', LEVEL: 'admin', ['姓名']: '管理員' };
                    setCurrentUserData(staff);
                    setView((term === 'admin' || String(staff.LEVEL).toLowerCase() === 'admin') ? 'admin-panel' : 'staff-tool');
                } else { alert(t.authFail); }
            };

            return (
                <div className="p-10 flex flex-1 flex-col items-center justify-center bg-slate-50 text-center no-print">
                    <BrandLogo className="mb-10 w-full" />
                    <h2 className="text-lg font-black mb-8 text-slate-700 border-b-4 border-orange-500 pb-1 uppercase">{t.staffValidation}</h2>
                    <input type="text" placeholder={t.adminEmailPlaceholder} className="w-full p-4 mb-4 bg-white rounded-2xl border border-slate-200 outline-none shadow-sm text-center" value={acc} onChange={(e) => setAcc(e.target.value)} />
                    <input type="password" placeholder={t.passwordPlaceholder} className="w-full p-4 mb-6 bg-white rounded-2xl border border-slate-200 outline-none shadow-sm text-center" value={pw} onChange={(e) => setPw(e.target.value)} onKeyPress={(e) => { if(e.key === 'Enter') login(); }} />
                    <button onClick={login} className="w-full bg-slate-900 text-white p-4 rounded-2xl font-black shadow-lg active:scale-95 transition-all">{t.sysLoginBtn}</button>
                    <button onClick={() => setView('lookup')} className="mt-8 text-slate-400 text-xs font-bold underline">{t.backToLookup}</button>
                </div>
            );
        }

        // --- 子組件：與會者儀表板 (專注於列印與狀態) ---
        function UserDashboard({ data, setView, BrandLogo, loadData, isSyncing, lang, setLang, t }) {
            const isVIP = checkIsVIP(data);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(data.ID || data.id || '')}`;

            const mealClaimed = !!(data['領餐時間'] || data.mealClaimed);
            const giftClaimed = !!(data['紀念品領取時間'] || data.giftClaimed);
            const company = data.Company || data.company || data['公司'] || '---';
            const title = data.Title || data.title || data['職稱'] || (lang === 'zh' ? '貴賓' : 'Guest');

            return (
                <div className="flex flex-col h-full bg-slate-50 overflow-hidden text-left">
                    {/* --- 列印區塊 --- */}
                    <div className="print-only">
                        <div className="label-container text-center">
                            <div className="label-header">{isVIP ? t.vip : t.normal}</div>
                            <div className="label-name">{data.Name || data.name || data['姓名']}</div>
                            <div className="label-title">{title}</div>
                            <div className="label-company">{company}</div>
                        </div>
                    </div>
                    
                    {/* --- 顯示區塊 --- */}
                    <div className="no-print h-full flex flex-col">
                        <div className={`${isVIP ? 'bg-gradient-to-br from-amber-500 to-[#f37021]' : 'bg-gradient-to-br from-blue-600 to-blue-800'} p-6 text-white pb-10 shadow-xl shrink-0`}>
                            <div className="flex justify-between items-center mb-6">
                                <BrandLogo invert className="w-28" />
                                <div className="flex gap-2">
                                    <button onClick={() => setLang(lang === 'zh' ? 'en' : 'zh')} className="px-3 py-1.5 bg-white/20 rounded-lg hover:bg-white/30 transition-all font-bold text-xs flex items-center gap-1">
                                        <Icon name="language" size={14} /> {lang === 'zh' ? 'EN' : '中文'}
                                    </button>
                                    <button onClick={loadData} className="p-2 bg-white/20 rounded-lg hover:bg-white/30 transition-all flex items-center">
                                        <Icon name="sync" size={18} className={isSyncing ? "animate-spin" : ""} />
                                    </button>
                                    <button onClick={() => setView('lookup')} className="p-2 bg-white/20 rounded-lg hover:bg-white/30 transition-all">
                                        <Icon name="logout" size={18}/>
                                    </button>
                                </div>
                            </div>
                            <div className="flex items-center gap-5">
                                <div className={`w-20 h-20 bg-white rounded-3xl flex items-center justify-center shadow-2xl shrink-0 ${isVIP ? 'text-amber-500' : 'text-blue-600'}`}>
                                    {isVIP ? <Icon name="workspace_premium" size={40} /> : <Icon name="person" size={40} />}
                                </div>
                                <div className="flex-1 min-w-0 text-left">
                                    <h2 className="text-2xl font-black truncate">{data.Name || data.name || data['姓名']}</h2>
                                    <p className="text-xs font-bold opacity-90 truncate">{company}</p>
                                    <p className="text-[10px] opacity-70 truncate uppercase tracking-widest mt-1">{title}</p>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto px-6 pb-6 space-y-6 pt-6 z-10">
                            <div className="bg-white p-6 rounded-[32px] flex flex-col items-center shadow-xl border border-slate-100 text-center">
                                <div className="p-3 bg-slate-50 rounded-3xl mb-4 border border-slate-100">
                                    <img src={qrUrl} className="w-48 h-48" alt="QR" />
                                </div>
                                <p className="text-[10px] font-black text-slate-300 tracking-[0.4em] uppercase mb-4">{t.electronicId}</p>
                                <button onClick={() => window.print()} className="w-full py-4 bg-slate-900 text-white rounded-2xl text-sm font-black shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                                    <Icon name="print" size={20}/> 
                                    {t.printLabel}
                                </button>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 text-center">
                                <div className={`p-4 rounded-3xl border shadow-sm ${mealClaimed ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                                    <Icon name="restaurant" className={`mx-auto mb-2 ${mealClaimed ? 'text-green-500' : 'text-slate-300'}`} size={28} />
                                    <p className={`text-[10px] font-black ${mealClaimed ? 'text-green-700' : 'text-slate-400'}`}>{t.mealClaim}<br/>{mealClaimed ? t.claimed : t.unclaimed}</p>
                                </div>
                                <div className={`p-4 rounded-3xl border shadow-sm ${giftClaimed ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100'}`}>
                                    <Icon name="redeem" className={`mx-auto mb-2 ${giftClaimed ? 'text-green-500' : 'text-slate-300'}`} size={28} />
                                    <p className={`text-[10px] font-black ${giftClaimed ? 'text-green-700' : 'text-slate-400'}`}>{t.giftClaim}<br/>{giftClaimed ? t.claimed : t.unclaimed}</p>
                                </div>
                            </div>
                            
                            <div>
                                <h3 className="text-xs font-black text-slate-800 mb-4 flex items-center gap-2 uppercase tracking-widest border-l-4 border-orange-500 pl-3">{t.details}</h3>
                                <div className="grid grid-cols-1 gap-3 pb-4">
                                    {Object.entries(data).filter(([k]) => !['id','uid','Passwd','LEVEL','Level','level','Email','type','姓名','公司','職稱','等級','信箱','領餐時間','紀念品領取時間','報到時間'].includes(k)).map(([key, val]) => (
                                        <div key={key} className="bg-white p-4 rounded-2xl border border-slate-100 flex flex-col gap-1 shadow-sm text-left">
                                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{key}</p>
                                            <p className="text-sm font-bold text-slate-700">{String(val) || "---"}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 子組件：工作人員核銷工具 ---
        function StaffTool({ user, dbData, setView, loadData, isSyncing, t }) {
            const [scanRes, setScanRes] = useState(null);
            const [scanMode, setScanMode] = useState('checkin'); // checkin, meal, souvenir
            const [manualId, setManualId] = useState('');
            const scannerRef = useRef(null);

            // 計算目前狀況
            const stats = useMemo(() => {
                let vIn = 0, nIn = 0, vTotal = 0, nTotal = 0, mealClaimed = 0, giftClaimed = 0;
                dbData.LIST?.forEach((a) => {
                    const isVIP = checkIsVIP(a);
                    if (isVIP) { vTotal++; if (a['報到時間']) vIn++; }
                    else { nTotal++; if (a['報到時間']) nIn++; }
                    if (a['領餐時間']) mealClaimed++;
                    if (a['紀念品領取時間']) giftClaimed++;
                });
                return { vIn, vTotal, nIn, nTotal, mealClaimed, giftClaimed, total: dbData.LIST?.length || 0 };
            }, [dbData.LIST]);

            const processCheckIn = (idText) => {
                const found = dbData.LIST?.find(a => String(a.ID) === idText || String(a.id) === idText);
                if (found) {
                    setScanRes({ ...found, status: 'found' });
                    fetch(API_URL, { method: 'POST', body: JSON.stringify({ id: idText, action: scanMode }) })
                    .then(res => res.json())
                    .then(result => {
                        if(result.status === "success") { setScanRes({ ...found, status: 'success', msg: result.message }); loadData(); } 
                        else if (result.status === "warning") { setScanRes({ ...found, status: 'warning', msg: result.message }); } 
                        else { setScanRes({ ...found, status: 'error', msg: '寫入失敗' }); }
                    }).catch(() => { setScanRes({ ...found, status: 'error', msg: '網路連線異常' }); });
                } else { setScanRes({ Name: "未知代碼", ID: idText, status: 'not_found', msg: '查無此人' }); }
            };

            useEffect(() => {
                let html5QrCode;
                if (!scanRes && document.getElementById("reader")) {
                    html5QrCode = new window.Html5Qrcode("reader");
                    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => { if (html5QrCode.isScanning) { html5QrCode.stop().then(() => { processCheckIn(decodedText); }).catch(e => {}); } }, () => {}
                    ).catch(e => {});
                    scannerRef.current = html5QrCode;
                }
                return () => { if (scannerRef.current && scannerRef.current.isScanning) { scannerRef.current.stop().catch(e => {}); } };
            }, [scanRes, scanMode]);

            return (
                <div className="flex flex-col h-full bg-slate-900 text-white p-4 no-print text-center">
                    <div className="flex justify-between items-center mb-4 mt-2 text-left">
                        <div className="flex items-center gap-2 text-orange-400 text-sm font-bold uppercase"><Icon name="how_to_reg" size={20} /><span>{user?.['姓名'] || user?.Name || '工作人員'}</span></div>
                        <div className="flex gap-2">
                            <button onClick={loadData} className="flex items-center gap-1 bg-white/10 px-3 py-1.5 rounded-xl text-xs font-bold hover:bg-white/20 transition-all"><Icon name="sync" size={14} className={isSyncing ? "animate-spin" : ""} />更新</button>
                            <button onClick={() => setView('lookup')} className="bg-white/10 px-3 py-1.5 rounded-xl text-xs font-bold">{t.logout}</button>
                        </div>
                    </div>
                    <div className="bg-slate-800/50 rounded-3xl p-4 mb-4 grid grid-cols-2 gap-3 text-left border border-white/5 shadow-2xl">
                        <div className="bg-slate-900/50 p-3 rounded-2xl border border-white/5"><p className="text-[10px] font-black text-amber-500 uppercase mb-1 flex items-center gap-1"><Icon name="star" size={10}/> {t.vipAttendance}</p><p className="text-xl font-black">{stats.vIn} <span className="text-[10px] text-slate-500 font-bold">/ {stats.vTotal}</span></p></div>
                        <div className="bg-slate-900/50 p-3 rounded-2xl border border-white/5"><p className="text-[10px] font-black text-blue-500 uppercase mb-1 flex items-center gap-1"><Icon name="group" size={10}/> {t.normalAttendance}</p><p className="text-xl font-black">{stats.nIn} <span className="text-[10px] text-slate-500 font-bold">/ {stats.nTotal}</span></p></div>
                        <div className="bg-slate-900/50 p-3 rounded-2xl border border-white/5"><p className="text-[10px] font-black text-emerald-500 uppercase mb-1 flex items-center gap-1"><Icon name="restaurant" size={10}/> {t.mealGiven}</p><p className="text-xl font-black">{stats.mealClaimed} <span className="text-[10px] text-slate-500 font-bold">/ {stats.total}</span></p></div>
                        <div className="bg-slate-900/50 p-3 rounded-2xl border border-white/5"><p className="text-[10px] font-black text-purple-500 uppercase mb-1 flex items-center gap-1"><Icon name="redeem" size={10}/> {t.giftGiven}</p><p className="text-xl font-black">{stats.giftClaimed} <span className="text-[10px] text-slate-500 font-bold">/ {stats.total}</span></p></div>
                    </div>
                    {!scanRes && (
                        <div className="flex bg-slate-800 p-1 rounded-xl mb-4 shadow-inner">
                            <button onClick={() => setScanMode('checkin')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${scanMode === 'checkin' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400'}`}>入場報到</button>
                            <button onClick={() => setScanMode('meal')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${scanMode === 'meal' ? 'bg-emerald-600 text-white shadow-md' : 'text-slate-400'}`}>{t.mealClaim}</button>
                            <button onClick={() => setScanMode('souvenir')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${scanMode === 'souvenir' ? 'bg-purple-600 text-white shadow-md' : 'text-slate-400'}`}>{t.giftClaim}</button>
                        </div>
                    )}
                    {!scanRes ? (
                        <div className="flex flex-col items-center flex-1 justify-center">
                            <div className={`border-4 shadow-[0_0_20px_rgba(0,0,0,0.5)] rounded-[32px] overflow-hidden mb-4 ${scanMode === 'checkin' ? 'border-blue-500' : scanMode === 'meal' ? 'border-emerald-500' : 'border-purple-500'}`}>
                                <div id="reader" className="w-full max-w-[300px] aspect-square relative bg-white"></div>
                            </div>
                            <div className="flex gap-2 w-full max-w-[300px]">
                                <input type="text" placeholder="手動輸入序號 ID" className="flex-1 bg-slate-800 border border-slate-700 text-white p-3 rounded-xl outline-none focus:border-orange-500 text-sm" value={manualId} onChange={e => setManualId(e.target.value)} onKeyPress={e => { if(e.key === 'Enter' && manualId.trim()) processCheckIn(manualId.trim()); }} />
                                <button onClick={() => { if(manualId.trim()) processCheckIn(manualId.trim()); }} className="bg-orange-600 hover:bg-orange-500 text-white px-5 rounded-xl font-bold text-sm transition shadow-lg">送出</button>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-slate-800 p-8 rounded-[48px] shadow-2xl text-left border border-slate-700 mt-4 text-center">
                            <div className="mb-4 flex justify-center">
                                {scanRes.status === 'found' ? <Icon name="sync" className="animate-spin text-slate-400" size={40} /> : 
                                 scanRes.status === 'success' ? <Icon name="check_circle" className="text-green-400" size={40} /> : 
                                 scanRes.status === 'warning' ? <Icon name="warning" className="text-yellow-400" size={40} /> : 
                                 <Icon name="cancel" className="text-red-400" size={40} />}
                            </div>
                            <h3 className="text-2xl font-black mb-1 text-white">{scanRes.Name || scanRes['姓名']}</h3>
                            <p className="text-xs font-bold text-slate-400 mb-6">{scanRes.Company || scanRes['公司']}</p>
                            <div className="mb-8 text-sm font-bold h-8 flex items-center justify-center">
                                {scanRes.status === 'found' && <span className="text-slate-400">寫入試算表中...</span>}
                                {scanRes.status === 'success' && <span className="text-green-400">{scanRes.msg}</span>}
                                {scanRes.status === 'warning' && <span className="text-yellow-400">{scanRes.msg}</span>}
                                {(scanRes.status === 'error' || scanRes.status === 'not_found') && <span className="text-red-400">{scanRes.msg}</span>}
                            </div>
                            <button onClick={() => {setScanRes(null); setManualId('');}} disabled={scanRes.status === 'found'} className={`w-full py-4 rounded-2xl font-bold uppercase tracking-widest ${scanRes.status === 'found' ? 'bg-slate-700 text-slate-500' : 'bg-orange-600 text-white hover:bg-orange-500'}`}>繼續作業</button>
                        </div>
                    )}
                </div>
            );
        }

        // --- 管理者中心 ---
        function AdminPanel({ dbData, setView, loadData, isSyncing, t }) {
            const [sending, setSending] = useState(false);
            const [eventName, setEventName] = useState(t.eventNameLabel.split(' ')[0] || "年度高峰論壇");
            const [templateId, setTemplateId] = useState("");
            const [emailContent, setEmailContent] = useState("親愛的 {{姓名}} 貴賓 您好：\n\n感謝您今日撥冗參與本活動。\n\n隨信附上您的專屬出席證明 PDF 檔，感謝您的支持與指教，期待未來再次相見。\n\n新動力公關 敬上");

            const checkedInCount = useMemo(() => {
                return dbData.LIST?.filter(a => a['報到時間']).length || 0;
            }, [dbData.LIST]);

            const handleSendCertificates = () => {
                if (!eventName || !templateId || !emailContent) {
                    return alert("請填寫完整的活動名稱、Google文件範本 ID 與信件內文。");
                }
                if (!confirm(`確定要將 PDF 出席證明寄給這 ${checkedInCount} 位已報到者嗎？\n(這需要由 Google Apps Script 在背景執行幾分鐘的時間)`)) return;

                setSending(true);
                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'send_certificates',
                        eventName: eventName,
                        templateId: templateId,
                        emailContent: emailContent
                    })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || "寄送指令完成！");
                    setSending(false);
                    loadData(); 
                })
                .catch(err => {
                    console.error(err);
                    alert("寄送時發生錯誤，請檢查 Google Apps Script 設定。");
                    setSending(false);
                });
            };

            return (
                <div className="p-6 space-y-6 h-full overflow-y-auto no-print text-left bg-slate-50">
                    <div className="flex justify-between items-center">
                        <h2 className="text-sm font-black uppercase tracking-widest text-slate-800 flex items-center gap-2"><Icon name="admin_panel_settings" /> {t.adminCenter}</h2>
                        <button onClick={() => setView('lookup')} className="text-slate-400 hover:text-slate-700"><Icon name="logout" size={20} /></button>
                    </div>

                    <div className="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{t.attendanceStats}</p>
                            <p className="text-3xl font-black text-slate-800">{checkedInCount} <span className="text-sm text-slate-300">/ {dbData.LIST?.length || 0}</span></p>
                        </div>
                        <button onClick={loadData} className="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:bg-slate-100 transition-colors">
                            <Icon name="sync" size={24} className={isSyncing ? "animate-spin" : ""} />
                        </button>
                    </div>

                    <div className="bg-white p-6 rounded-[32px] border border-blue-100 shadow-lg">
                        <div className="flex items-center gap-2 mb-4 text-blue-700">
                            <Icon name="mail" />
                            <h3 className="font-black">{t.sendCert}</h3>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{t.eventNameLabel}</label>
                                <input type="text" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:border-blue-500" value={eventName} onChange={e => setEventName(e.target.value)} />
                            </div>

                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{t.docIdLabel}</label>
                                <input type="text" placeholder={t.docIdPlaceholder} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs outline-none focus:border-blue-500 font-mono" value={templateId} onChange={e => setTemplateId(e.target.value)} />
                            </div>

                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">{t.emailContentLabel}</label>
                                <textarea className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-blue-500 h-32 leading-relaxed" value={emailContent} onChange={e => setEmailContent(e.target.value)}></textarea>
                            </div>

                            <button onClick={handleSendCertificates} disabled={sending} className={`w-full p-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg transition-all ${sending ? 'bg-slate-200 text-slate-500' : 'bg-blue-600 text-white hover:bg-blue-700 active:scale-95'}`}>
                                <Icon name={sending ? "sync" : "send"} size={18} className={sending ? "animate-spin" : ""} />
                                {sending ? t.sending : t.sendBtn.replace('{count}', checkedInCount)}
                            </button>
                        </div>
                    </div>
                    
                    <button onClick={() => window.open(GOOGLE_SHEET_URL, '_blank')} className="w-full p-4 bg-[#f37021] text-white rounded-2xl font-black uppercase text-xs flex items-center justify-center gap-2 active:scale-95 transition-all shadow-md">
                        <Icon name="open_in_new" size={16}/> {t.openSheet}
                    </button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
