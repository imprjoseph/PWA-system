<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>新動力公關 - 管理與報到系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/lucide-react/dist/umd/lucide-react.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fade-in 0.5s ease-out; }
    body { background-color: #0f172a; margin: 0; font-family: sans-serif; }
    /* 縮小掃描器視窗 */
    #reader { width: 100% !important; max-width: 320px; margin: 0 auto; border: none !important; border-radius: 1rem; overflow: hidden; }
    #reader__scan_region { background: white; }
  </style>
</head>
<body>
  <div id="root">系統初始化中...</div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const Icon = ({ name, ...props }) => {
      const LucideIcon = window.LucideReact ? window.LucideReact[name] : null;
      return LucideIcon ? <LucideIcon {...props} /> : null;
    };

    function App() {
      const [db, setDb] = useState({ LIST: [], NEWS: [], WORKER: [], AGENDA: [] });
      const [view, setView] = useState('lookup'); 
      const [user, setUser] = useState(null);
      const [input, setInput] = useState('');
      const [staffAccount, setStaffAccount] = useState('');
      const [staffPassword, setStaffPassword] = useState('');
      const [loggedStaff, setLoggedStaff] = useState(null);
      const [scanResult, setScanResult] = useState(null);
      const [isSyncing, setIsSyncing] = useState(false);
      const [scanMode, setScanMode] = useState('checkin');

      // 你的 API 網址
      const API = "https://script.google.com/macros/s/AKfycbxU8QsPsv2RohYWzED_nqip9owyQP14zrJsE439bNOPtYseeouIIePNdyqYeFXuGKcS/exec";

      const loadData = () => {
        setIsSyncing(true);
        fetch(API).then(res => res.json()).then(data => {
          setDb(data);
          if(user) {
            const updatedUser = data.LIST.find(a => String(a.ID) === String(user.ID));
            if(updatedUser) setUser(updatedUser);
          }
          setIsSyncing(false);
        }).catch(() => setIsSyncing(false));
      };

      useEffect(() => { loadData(); }, []);

      const stats = useMemo(() => {
        let vTotal = 0, vIn = 0, nTotal = 0, nIn = 0;
        let mealClaimed = 0, souvenirClaimed = 0;
        db.LIST.forEach(row => {
          const lv = String(row.Level || row['等級'] || '').toUpperCase();
          if (lv === 'VIP') { vTotal++; if (row['報到時間']) vIn++; }
          else { nTotal++; if (row['報到時間']) nIn++; }
          if (row['領餐時間']) mealClaimed++;
          if (row['紀念品領取時間']) souvenirClaimed++;
        });
        return { vTotal, vIn, nTotal, nIn, mealClaimed, souvenirClaimed, totalPeople: vTotal + nTotal };
      }, [db.LIST]);

      useEffect(() => {
        if (view === 'scanner') {
          const html5QrCode = new Html5Qrcode("reader");
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
              const found = db.LIST.find(a => String(a.ID) === decodedText);
              html5QrCode.stop(); 
              if (found) {
                setScanResult({ ...found, status: 'found' });
                setIsSyncing(true);
                fetch(API, { method: 'POST', body: JSON.stringify({ id: decodedText, action: scanMode }) })
                .then(res => res.json())
                .then(result => {
                  setIsSyncing(false);
                  if(result.status === "success") {
                    setScanResult({ ...found, status: 'success', successMsg: result.message });
                    loadData(); 
                  } else if (result.status === "warning") {
                    setScanResult({ ...found, status: 'warning', errorMsg: result.message });
                  } else {
                    setScanResult({ ...found, status: 'error', errorMsg: '寫入失敗' });
                  }
                }).catch(() => {
                  setIsSyncing(false);
                  setScanResult({ ...found, status: 'error', errorMsg: '網路連線異常' });
                });
              } else {
                setScanResult({ Name: "未知代碼", ID: decodedText, status: 'not_found' });
              }
            }, () => {}
          );
          return () => { if(html5QrCode.isScanning) html5QrCode.stop(); };
        }
      }, [view, db.LIST, scanMode]);

      // 共用元件：最新消息與議程
      const InfoSection = ({ isDark = false }) => (
        <div className="mt-6 space-y-4">
          <div className={`${isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-100 text-slate-800'} p-5 rounded-3xl shadow-lg border`}>
            <h3 className="text-lg font-bold mb-3 flex items-center gap-2"><Icon name="Bell" className="text-orange-500" size={20}/> 最新消息</h3>
            {db.NEWS?.length > 0 ? db.NEWS.map((n, i) => (
              <div key={i} className={`mb-3 pb-3 border-b last:border-0 last:mb-0 last:pb-0 ${isDark ? 'border-slate-700' : 'border-slate-100'}`}>
                <p className={`text-xs ${isDark ? 'text-slate-400' : 'text-slate-500'} font-bold mb-1`}>{n['時間'] || n.Time}</p>
                <p className={`text-sm ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>{n['內容'] || n.Content || n.Title}</p>
              </div>
            )) : <p className={`text-sm ${isDark ? 'text-slate-400' : 'text-slate-500'}`}>目前無最新消息</p>}
          </div>

          <div className={`${isDark ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-100 text-slate-800'} p-5 rounded-3xl shadow-lg border`}>
            <h3 className="text-lg font-bold mb-3 flex items-center gap-2"><Icon name="CalendarDays" className="text-blue-500" size={20}/> 大會議程</h3>
            {db.AGENDA?.length > 0 ? db.AGENDA.map((a, i) => (
              <div key={i} className={`flex gap-3 mb-3 pb-3 border-b last:border-0 last:mb-0 last:pb-0 ${isDark ? 'border-slate-700' : 'border-slate-100'}`}>
                <div className="text-sm font-bold text-blue-500 whitespace-nowrap">{a['時間'] || a.Time}</div>
                <div className={`text-sm ${isDark ? 'text-slate-200' : 'text-slate-700'}`}>{a['議程'] || a.Title || a.Content}</div>
              </div>
            )) : <p className={`text-sm ${isDark ? 'text-slate-400' : 'text-slate-500'}`}>目前無議程資訊</p>}
          </div>
        </div>
      );

      // --- 畫面一：工作人員登入 ---
      if (view === 'staffLogin') {
        return (
          <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 animate-fade-in">
            <div className="max-w-md w-full bg-slate-800 p-8 rounded-[30px] shadow-2xl border border-slate-700">
              <div className="flex justify-between items-center mb-6">
                <button onClick={() => setView('lookup')} className="text-slate-400 hover:text-white flex items-center gap-1"><Icon name="ArrowLeft" size={18}/> 回上一頁</button>
                <div className="px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-xs font-bold tracking-widest flex items-center gap-1"><Icon name="Lock" size={12}/> STAFF</div>
              </div>
              <h2 className="text-2xl font-bold text-white mb-6 text-center">後台管理登入</h2>
              <input type="text" placeholder="帳號" className="w-full p-4 mb-4 bg-slate-900 text-white border border-slate-700 rounded-xl outline-none" value={staffAccount} onChange={e => setStaffAccount(e.target.value)} />
              <input type="password" placeholder="密碼" className="w-full p-4 mb-6 bg-slate-900 text-white border border-slate-700 rounded-xl outline-none" value={staffPassword} onChange={e => setStaffPassword(e.target.value)} />
              <button onClick={() => {
                const foundStaff = db.WORKER.find(w => String(w['帳號']) === staffAccount && String(w['密碼']) === staffPassword);
                if(foundStaff) { setLoggedStaff(foundStaff); setView('scanner'); setStaffAccount(''); setStaffPassword(''); } 
                else { alert("帳號或密碼錯誤！"); }
              }} className="w-full bg-orange-600 text-white p-4 rounded-xl font-bold hover:bg-orange-500">登入系統</button>
            </div>
          </div>
        );
      }

      // --- 畫面二：工作人員掃描介面 ---
      if (view === 'scanner') {
        return (
          <div className="min-h-screen bg-slate-900 text-white p-4 animate-fade-in pb-10">
            <div className="flex justify-between items-center mb-4 mt-2">
              <h1 className="text-lg font-bold flex items-center gap-2 text-orange-400"><Icon name="Scan" size={20} /> 管理員: {loggedStaff?.['姓名'] || '未命名'}</h1>
              <div className="flex gap-2">
                <button onClick={loadData} className="text-slate-400 border border-slate-700 px-3 py-1 rounded-lg text-sm flex items-center gap-1 hover:bg-slate-800"><Icon name="RefreshCw" size={14} className={isSyncing ? "animate-spin" : ""} /> 更新</button>
                <button onClick={() => {setView('lookup'); setScanResult(null); setLoggedStaff(null);}} className="text-slate-400 border border-slate-700 px-3 py-1 rounded-lg text-sm flex items-center gap-1 hover:bg-slate-800"><Icon name="LogOut" size={14} /> 登出</button>
              </div>
            </div>

            <div className="bg-slate-800 rounded-2xl p-4 mb-4 grid grid-cols-2 gap-4 text-sm shadow-lg border border-slate-700">
              <div className="bg-slate-900 p-3 rounded-xl border border-slate-700"><p className="text-slate-400 mb-1 flex items-center gap-1"><Icon name="Star" size={14} className="text-amber-400"/> VIP 報到</p><p className="text-xl font-bold">{stats.vIn} <span className="text-xs text-slate-500">/ {stats.vTotal}</span></p></div>
              <div className="bg-slate-900 p-3 rounded-xl border border-slate-700"><p className="text-slate-400 mb-1 flex items-center gap-1"><Icon name="User" size={14} className="text-blue-400"/> 一般報到</p><p className="text-xl font-bold">{stats.nIn} <span className="text-xs text-slate-500">/ {stats.nTotal}</span></p></div>
              <div className="bg-slate-900 p-3 rounded-xl border border-slate-700"><p className="text-slate-400 mb-1 flex items-center gap-1"><Icon name="Utensils" size={14} className="text-emerald-400"/> 發放餐點</p><p className="text-xl font-bold">{stats.mealClaimed} <span className="text-xs text-slate-500">/ {stats.totalPeople}</span></p></div>
              <div className="bg-slate-900 p-3 rounded-xl border border-slate-700"><p className="text-slate-400 mb-1 flex items-center gap-1"><Icon name="Gift" size={14} className="text-purple-400"/> 發放紀念品</p><p className="text-xl font-bold">{stats.souvenirClaimed} <span className="text-xs text-slate-500">/ {stats.totalPeople}</span></p></div>
            </div>

            {!scanResult && (
              <div className="flex bg-slate-800 p-1 rounded-xl mb-4 shadow-inner">
                <button onClick={() => setScanMode('checkin')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${scanMode === 'checkin' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400'}`}>報到</button>
                <button onClick={() => setScanMode('meal')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${scanMode === 'meal' ? 'bg-emerald-600 text-white shadow-md' : 'text-slate-400'}`}>領餐</button>
                <button onClick={() => setScanMode('souvenir')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${scanMode === 'souvenir' ? 'bg-purple-600 text-white shadow-md' : 'text-slate-400'}`}>紀念品</button>
              </div>
            )}
            
            {!scanResult ? (
              <div className={`border-4 shadow-[0_0_20px_rgba(0,0,0,0.5)] rounded-2xl mx-auto overflow-hidden ${scanMode === 'checkin' ? 'border-blue-500' : scanMode === 'meal' ? 'border-emerald-500' : 'border-purple-500'}`}>
                <div id="reader"></div>
              </div>
            ) : (
              <div className="bg-slate-800 text-white p-8 rounded-3xl text-center border border-slate-700">
                <div className={`w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center ${scanResult.status === 'success' ? 'bg-green-900 text-green-400' : scanResult.status === 'warning' ? 'bg-yellow-900 text-yellow-400' : 'bg-red-900 text-red-400'}`}>
                  {isSyncing ? <Icon name="Loader2" className="animate-spin" size={32} /> : scanResult.status === 'success' ? <Icon name="CheckCircle" size={32} /> : scanResult.status === 'warning' ? <Icon name="AlertTriangle" size={32} /> : <Icon name="XCircle" size={32} />}
                </div>
                <h2 className="text-2xl font-bold mb-1">{scanResult.Name}</h2>
                <div className="flex items-center justify-center gap-2 mb-4">
                  <span className={`px-2 py-0.5 rounded-md text-xs font-bold ${String(scanResult.Level).toUpperCase() === 'VIP' ? 'bg-amber-900 text-amber-400' : 'bg-blue-900 text-blue-400'}`}>{scanResult.Level || 'NORMAL'}</span>
                  <span className="text-slate-400">{scanResult.Company || "無公司資料"}</span>
                </div>
                <div className="mb-6 h-6">
                  {isSyncing && <span className="text-slate-400 font-bold text-sm">寫入中...</span>}
                  {scanResult.status === 'success' && <span className="text-green-400 font-bold text-sm">{scanResult.successMsg}</span>}
                  {scanResult.status === 'warning' && <span className="text-yellow-400 font-bold text-sm">{scanResult.errorMsg}</span>}
                  {scanResult.status === 'error' && <span className="text-red-400 font-bold text-sm">{scanResult.errorMsg}</span>}
                  {scanResult.status === 'not_found' && <span className="text-red-400 font-bold text-sm">查無此人</span>}
                </div>
                <button onClick={() => setScanResult(null)} disabled={isSyncing} className={`w-full p-4 rounded-xl font-bold ${isSyncing ? 'bg-slate-700 text-slate-500' : 'bg-orange-600 text-white hover:bg-orange-500'}`}>繼續掃描</button>
              </div>
            )}

            {/* 工作人員畫面的最新消息與議程 */}
            {!scanResult && <InfoSection isDark={true} />}
          </div>
        );
      }

      // --- 畫面三：與會者個人頁面 ---
      if (view === 'dashboard' && user) {
        const isVip = String(user.Level || user['等級'] || '').toUpperCase() === 'VIP';
        const themeBg = isVip ? 'bg-gradient-to-br from-amber-500 to-yellow-600' : 'bg-gradient-to-br from-blue-600 to-indigo-700';
        const badgeBg = isVip ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-blue-100 text-blue-700 border-blue-200';
        
        return (
          <div className="min-h-screen bg-slate-50 flex flex-col animate-fade-in pb-10">
            <div className={`p-6 pt-8 ${themeBg} text-white rounded-b-[40px] shadow-lg relative z-10`}>
              <div className="flex justify-between items-center mb-4">
                <button onClick={() => {setUser(null); setView('lookup'); setInput('');}} className="flex items-center gap-1 font-medium hover:text-slate-200 transition"><Icon name="ArrowLeft" size={20} /> 回首頁</button>
                <button onClick={loadData} className="flex items-center gap-1 font-medium hover:text-slate-200 transition"><Icon name="RefreshCw" size={18} className={isSyncing ? "animate-spin" : ""} /> 更新資料</button>
              </div>
              <div className="flex items-center gap-2 mb-1">
                <h2 className="text-3xl font-black">{user.Name}</h2>
                <div className="flex items-center gap-1 font-bold tracking-widest bg-white/20 px-2 py-0.5 rounded-md text-xs">{isVip && <Icon name="Star" size={12} className="fill-white" />} {isVip ? 'VIP' : 'GUEST'}</div>
              </div>
              <p className="opacity-90 font-medium text-lg">{user.Title || user['職稱']}</p>
            </div>

            <div className="px-5 -mt-6 relative z-20 flex flex-col items-center">
              <div className="w-full bg-white p-6 shadow-xl rounded-[30px] border border-slate-100 flex flex-col items-center mb-5">
                <div className="p-3 bg-slate-50 rounded-2xl mb-2 border border-slate-100">
                  <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${user.ID}`} className="w-40 h-40" alt="QR Code" />
                </div>
                <p className="font-bold text-slate-400 tracking-widest text-[10px]">專屬報到憑證</p>
              </div>

              <div className="w-full bg-white p-6 shadow-xl rounded-[30px] border border-slate-100">
                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="FileText" className="text-slate-400" size={20} /> 基本資訊</h3>
                <div className="space-y-3 text-sm mb-6">
                  <div className="flex justify-between items-center border-b border-slate-100 pb-2"><span className="text-slate-500">所屬公司</span><span className="font-bold text-slate-800 text-right">{user.Company || user['公司'] || '-'}</span></div>
                  <div className="flex justify-between items-center border-b border-slate-100 pb-2"><span className="text-slate-500">聯絡信箱</span><span className="font-bold text-slate-800 text-right">{user.Email || '-'}</span></div>
                  <div className="flex justify-between items-center border-b border-slate-100 pb-2"><span className="text-slate-500">餐點需求</span><span className={`font-bold border px-2 py-0.5 rounded-md ${badgeBg}`}>{user.Eating || user['餐點'] || '無特別備註'}</span></div>
                </div>

                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="CheckCircle" className="text-slate-400" size={20} /> 領取狀態</h3>
                <div className="grid grid-cols-2 gap-3">
                  <div className={`p-3 rounded-xl border flex flex-col items-center justify-center text-center ${user['領餐時間'] ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-slate-200'}`}>
                    <Icon name="Utensils" size={24} className={`mb-1 ${user['領餐時間'] ? 'text-emerald-500' : 'text-slate-300'}`} />
                    <span className={`font-bold text-sm ${user['領餐時間'] ? 'text-emerald-700' : 'text-slate-500'}`}>{user['領餐時間'] ? '餐點已領取' : '餐點未領'}</span>
                  </div>
                  <div className={`p-3 rounded-xl border flex flex-col items-center justify-center text-center ${user['紀念品領取時間'] ? 'bg-purple-50 border-purple-200' : 'bg-slate-50 border-slate-200'}`}>
                    <Icon name="Gift" size={24} className={`mb-1 ${user['紀念品領取時間'] ? 'text-purple-500' : 'text-slate-300'}`} />
                    <span className={`font-bold text-sm ${user['紀念品領取時間'] ? 'text-purple-700' : 'text-slate-500'}`}>{user['紀念品領取時間'] ? '紀念品已領取' : '紀念品未領'}</span>
                  </div>
                </div>
              </div>

              {/* 與會者畫面的最新消息與議程 */}
              <div className="w-full"><InfoSection isDark={false} /></div>
            </div>
          </div>
        );
      }

      // --- 畫面四：與會者首頁 ---
      return (
        <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6">
          <div className="max-w-md w-full bg-white p-10 rounded-[40px] shadow-2xl animate-fade-in relative">
            <div className="flex justify-center mb-6">
               <img src="https://imprjoseph.github.io/PWA-system/logo.png" alt="新動力公關" className="h-16 w-auto object-contain" onError={(e) => { e.target.style.display='none'; document.getElementById('logo-fallback').style.display='block'; }}/>
               <div id="logo-fallback" className="hidden text-2xl font-black text-orange-600">IMPR 新動力公關</div>
            </div>
            <h1 className="text-xl font-bold text-center mb-8 text-slate-600">活動報到系統</h1>
            <input type="text" placeholder="請輸入 Email 或 手機號碼" className="w-full p-4 mb-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-[#f37021]" value={input} onChange={e => setInput(e.target.value)} />
            <button onClick={() => {
              const found = db.LIST.find(a => String(a.Email) === input || String(a.Phone) === input);
              if(found) { setUser(found); setView('dashboard'); } else { alert("查無資料，請確認輸入是否有誤。"); }
            }} className="w-full bg-[#f37021] text-white p-4 rounded-2xl font-bold mb-4 shadow-lg shadow-orange-200 hover:bg-[#e06117]">登入查詢</button>
            <button onClick={() => setView('staffLogin')} className="w-full border-2 border-slate-100 text-slate-400 p-4 rounded-2xl font-bold flex items-center justify-center gap-2 mt-4 hover:bg-slate-50">
              <Icon name="Lock" size={16} /> 工作人員入口
            </button>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
